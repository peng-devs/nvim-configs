# 3.1 狀態列系統設置企劃書 - lualine

## 專案概覽
建立資訊豐富且美觀的狀態列系統，顯示檔案資訊、Git 分支、LSP 狀態、診斷資訊等開發相關資訊。

## 目標與預期成果
- ✅ 豐富的檔案和編輯器資訊顯示
- ✅ Git 分支和變更統計
- ✅ LSP 狀態和診斷資訊
- ✅ 自定義模組和主題支援
- ✅ 效能優化和響應式設計

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成相關模組 (LSP、Git 等，可選)
- Nerd Font 字體 (用於圖示顯示)

## 核心套件組合
1. **lualine.nvim** - 狀態列核心
2. **nvim-web-devicons** - 檔案類型圖示

## 實施步驟

### 步驟 1: 基本 Lualine 設置
**位置**: `lua/plugins/ui/lualine.lua`

```lua
return {
  "nvim-lualine/lualine.nvim",
  dependencies = { "nvim-tree/nvim-web-devicons" },
  event = "VeryLazy",
  config = function()
    local lualine = require("lualine")

    -- 自定義顏色和主題
    local colors = {
      bg       = '#202328',
      fg       = '#bbc2cf',
      yellow   = '#ECBE7B',
      cyan     = '#008080',
      darkblue = '#081633',
      green    = '#98be65',
      orange   = '#FF8800',
      violet   = '#a9a1e1',
      magenta  = '#c678dd',
      blue     = '#51afef',
      red      = '#ec5f67',
    }

    local conditions = {
      buffer_not_empty = function()
        return vim.fn.empty(vim.fn.expand('%:t')) ~= 1
      end,
      hide_in_width = function()
        return vim.fn.winwidth(0) > 80
      end,
      check_git_workspace = function()
        local filepath = vim.fn.expand('%:p:h')
        local gitdir = vim.fn.finddir('.git', filepath .. ';')
        return gitdir and #gitdir > 0 and #gitdir < #filepath
      end,
    }

    -- 自定義模組
    local config = {
      options = {
        component_separators = '',
        section_separators = '',
        theme = {
          normal = { c = { fg = colors.fg, bg = colors.bg } },
          inactive = { c = { fg = colors.fg, bg = colors.bg } },
        },
        disabled_filetypes = {
          statusline = { "alpha", "dashboard", "NvimTree", "Outline" },
          winbar = {},
        },
        ignore_focus = {},
        always_divide_middle = true,
        globalstatus = true,
        refresh = {
          statusline = 1000,
          tabline = 1000,
          winbar = 1000,
        },
      },
      sections = {
        lualine_a = {},
        lualine_b = {},
        lualine_y = {},
        lualine_z = {},
        lualine_c = {},
        lualine_x = {},
      },
      inactive_sections = {
        lualine_a = {},
        lualine_b = {},
        lualine_y = {},
        lualine_z = {},
        lualine_c = {},
        lualine_x = {},
      },
    }

    -- 插入組件的輔助函數
    local function ins_left(component)
      table.insert(config.sections.lualine_c, component)
    end

    local function ins_right(component)
      table.insert(config.sections.lualine_x, component)
    end

    -- 左側開始標記
    ins_left {
      function()
        return '▊'
      end,
      color = { fg = colors.blue },
      padding = { left = 0, right = 1 },
    }

    -- Vim 模式
    ins_left {
      function()
        local mode_color = {
          n = colors.red,
          i = colors.green,
          v = colors.blue,
          [''] = colors.blue,
          V = colors.blue,
          c = colors.magenta,
          no = colors.red,
          s = colors.orange,
          S = colors.orange,
          [''] = colors.orange,
          ic = colors.yellow,
          R = colors.violet,
          Rv = colors.violet,
          cv = colors.red,
          ce = colors.red,
          r = colors.cyan,
          rm = colors.cyan,
          ['r?'] = colors.cyan,
          ['!'] = colors.red,
          t = colors.red,
        }
        vim.api.nvim_command('hi! LualineMode guifg=' .. mode_color[vim.fn.mode()] .. ' guibg=' .. colors.bg)
        return ''
      end,
      color = 'LualineMode',
      padding = { right = 1 },
    }

    -- 檔案大小
    ins_left {
      'filesize',
      cond = conditions.buffer_not_empty,
    }

    -- 檔案名稱
    ins_left {
      'filename',
      cond = conditions.buffer_not_empty,
      color = { fg = colors.magenta, gui = 'bold' },
      path = 1, -- 0: 只有檔名, 1: 相對路徑, 2: 絕對路徑
      symbols = {
        modified = '[+]',
        readonly = '[-]',
        unnamed = '[No Name]',
        newfile = '[New]',
      },
    }

    -- Git 分支
    ins_left {
      'branch',
      icon = '',
      color = { fg = colors.violet, gui = 'bold' },
    }

    -- Git 差異
    ins_left {
      'diff',
      symbols = { added = ' ', modified = '󰝤 ', removed = ' ' },
      diff_color = {
        added = { fg = colors.green },
        modified = { fg = colors.orange },
        removed = { fg = colors.red },
      },
      cond = conditions.hide_in_width,
    }

    -- 中間分隔符
    ins_left {
      function()
        return '%='
      end,
    }

    -- LSP 狀態
    ins_left {
      function()
        local msg = 'No Active Lsp'
        local buf_ft = vim.api.nvim_buf_get_option(0, 'filetype')
        local clients = vim.lsp.get_active_clients()
        if next(clients) == nil then
          return msg
        end
        for _, client in ipairs(clients) do
          local filetypes = client.config.filetypes
          if filetypes and vim.fn.index(filetypes, buf_ft) ~= -1 then
            return client.name
          end
        end
        return msg
      end,
      icon = ' LSP:',
      color = { fg = '#ffffff', gui = 'bold' },
    }

    -- 右側組件

    -- 診斷資訊
    ins_right {
      'diagnostics',
      sources = { 'nvim_diagnostic' },
      symbols = { error = ' ', warn = ' ', info = ' ' },
      diagnostics_color = {
        color_error = { fg = colors.red },
        color_warn = { fg = colors.yellow },
        color_info = { fg = colors.cyan },
      },
    }

    -- Treesitter 狀態
    ins_right {
      function()
        return ''
      end,
      color = function()
        local buf = vim.api.nvim_get_current_buf()
        local ts = vim.treesitter.highlighter.active[buf]
        return { fg = ts and not vim.tbl_isempty(ts) and colors.green or colors.red }
      end,
      cond = conditions.hide_in_width,
    }

    -- 檔案類型
    ins_right {
      'filetype',
      fmt = string.upper,
      icons_enabled = false,
      color = { fg = colors.white, gui = 'bold' },
    }

    -- 檔案編碼
    ins_right {
      'o:encoding',
      fmt = string.upper,
      cond = conditions.hide_in_width,
      color = { fg = colors.white, gui = 'bold' },
    }

    -- 檔案格式
    ins_right {
      'fileformat',
      fmt = string.upper,
      icons_enabled = false,
      color = { fg = colors.white, gui = 'bold' },
    }

    -- 游標位置
    ins_right {
      'location',
      color = { fg = colors.fg, gui = 'bold' },
    }

    -- 進度百分比
    ins_right {
      'progress',
      color = { fg = colors.fg, gui = 'bold' },
    }

    -- 右側結束標記
    ins_right {
      function()
        return '▊'
      end,
      color = { fg = colors.blue },
      padding = { left = 1 },
    }

    -- 應用配置
    lualine.setup(config)
  end,
}
```

### 步驟 2: 自定義模組和主題
**位置**: `lua/plugins/ui/lualine-custom.lua`

```lua
return {
  "nvim-lualine/lualine.nvim",
  dependencies = { "nvim-tree/nvim-web-devicons" },
  config = function()
    -- 自定義模組

    -- 顯示當前時間
    local function clock()
      return os.date("%H:%M")
    end

    -- 顯示當前 Python 虛擬環境
    local function python_env()
      if vim.bo.filetype == "python" then
        local venv = os.getenv("VIRTUAL_ENV")
        if venv then
          return string.match(venv, "([^/]+)$")
        end
      end
      return ""
    end

    -- 顯示當前工作目錄
    local function cwd()
      return vim.fn.fnamemodify(vim.fn.getcwd(), ":t")
    end

    -- 顯示緩衝區數量
    local function buffer_count()
      return #vim.fn.getbufinfo({buflisted = 1})
    end

    -- 顯示 LSP 進度
    local function lsp_progress()
      local lsp = vim.lsp.util.get_progress_messages()[1]
      if lsp then
        local name = lsp.name or ""
        local msg = lsp.message or ""
        local percentage = lsp.percentage or 0
        local title = lsp.title or ""
        return string.format(" %%<%s: %s %s (%s%%%%)", name, title, msg, percentage)
      end
      return ""
    end

    -- 顯示搜尋結果
    local function search_result()
      if vim.v.hlsearch == 0 then
        return ""
      end
      local last_search = vim.fn.getreg("/")
      if not last_search or last_search == "" then
        return ""
      end
      local searchcount = vim.fn.searchcount { maxcount = 9999 }
      return last_search .. "(" .. searchcount.current .. "/" .. searchcount.total .. ")"
    end

    -- 主題配置
    local custom_theme = {
      normal = {
        a = { bg = '#98be65', fg = '#000000', gui = 'bold' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#32302f', fg = '#a89984' },
      },
      insert = {
        a = { bg = '#83a598', fg = '#000000', gui = 'bold' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#32302f', fg = '#a89984' },
      },
      visual = {
        a = { bg = '#fe8019', fg = '#000000', gui = 'bold' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#32302f', fg = '#a89984' },
      },
      replace = {
        a = { bg = '#fb4934', fg = '#000000', gui = 'bold' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#32302f', fg = '#a89984' },
      },
      command = {
        a = { bg = '#fabd2f', fg = '#000000', gui = 'bold' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#32302f', fg = '#a89984' },
      },
      inactive = {
        a = { bg = '#3c3836', fg = '#a89984' },
        b = { bg = '#3c3836', fg = '#a89984' },
        c = { bg = '#3c3836', fg = '#a89984' },
      },
    }

    require("lualine").setup({
      options = {
        theme = custom_theme,
        component_separators = { left = '', right = '' },
        section_separators = { left = '', right = '' },
        globalstatus = true,
      },
      sections = {
        lualine_a = { 'mode' },
        lualine_b = {
          'branch',
          'diff',
          {
            'diagnostics',
            sources = { 'nvim_diagnostic', 'coc' },
            symbols = { error = ' ', warn = ' ', info = ' ' },
          },
        },
        lualine_c = {
          {
            'filename',
            file_status = true,
            newfile_status = false,
            path = 1,
            symbols = {
              modified = '[+]',
              readonly = '[-]',
              unnamed = '[No Name]',
              newfile = '[New]',
            },
          },
          { lsp_progress },
        },
        lualine_x = {
          { python_env, icon = '' },
          { search_result, icon = '' },
          'encoding',
          'fileformat',
          'filetype',
        },
        lualine_y = {
          { buffer_count, icon = '' },
          'progress',
        },
        lualine_z = {
          'location',
          { clock, icon = '' },
        },
      },
      inactive_sections = {
        lualine_a = {},
        lualine_b = {},
        lualine_c = { 'filename' },
        lualine_x = { 'location' },
        lualine_y = {},
        lualine_z = {},
      },
      tabline = {},
      winbar = {
        lualine_a = {},
        lualine_b = {},
        lualine_c = {
          {
            'filename',
            path = 1,
          },
        },
        lualine_x = {},
        lualine_y = {},
        lualine_z = {},
      },
      inactive_winbar = {
        lualine_a = {},
        lualine_b = {},
        lualine_c = { 'filename' },
        lualine_x = {},
        lualine_y = {},
        lualine_z = {},
      },
      extensions = { 'nvim-tree', 'toggleterm', 'fugitive' },
    })
  end,
}
```

## 驗證與測試

### 基本功能測試
1. **狀態列顯示測試**:
   - 檢查各種模式下的顏色變化
   - 確認檔案資訊正確顯示
   - 驗證 Git 資訊更新

2. **響應性測試**:
   - 調整視窗大小檢查適應性
   - 測試不同檔案類型的顯示

3. **整合功能測試**:
   - LSP 狀態顯示
   - 診斷資訊更新
   - Git 分支切換反應

## 自定義配置選項

### 簡化版設置
```lua
require('lualine').setup {
  options = {
    theme = 'auto',
    component_separators = { left = '', right = ''},
    section_separators = { left = '', right = ''},
    disabled_filetypes = {},
    always_divide_middle = true,
    globalstatus = true,
  },
  sections = {
    lualine_a = {'mode'},
    lualine_b = {'branch', 'diff', 'diagnostics'},
    lualine_c = {'filename'},
    lualine_x = {'encoding', 'fileformat', 'filetype'},
    lualine_y = {'progress'},
    lualine_z = {'location'}
  },
}
```

### 最小化設置
```lua
require('lualine').setup {
  options = {
    theme = 'auto',
    icons_enabled = false,
    component_separators = '',
    section_separators = '',
  }
}
```

## 常見問題與解決方案

### Q1: 狀態列不顯示或顯示異常
**檢查項目**:
1. 確認 lualine 已正確安裝
2. 檢查主題配置是否正確
3. 確認終端支援真彩色

### Q2: Git 資訊不更新
**解決方案**:
1. 確認在 Git 倉庫中
2. 檢查 Git 狀態: `git status`
3. 重新載入配置: `<leader>sv`

### Q3: LSP 狀態不顯示
**檢查項目**:
1. 確認 LSP 已啟動: `:LspInfo`
2. 檢查檔案類型支援
3. 確認 lualine LSP 模組配置

### Q4: 圖示顯示問題
**解決方案**:
1. 確認安裝 Nerd Font
2. 檢查終端字體設置
3. 設置 `icons_enabled = false` 禁用圖示

## 效能優化

### 減少更新頻率
```lua
options = {
  refresh = {
    statusline = 1000,
    tabline = 1000,
    winbar = 1000,
  },
}
```

### 條件顯示
```lua
{
  'diagnostics',
  cond = function()
    return vim.fn.winwidth(0) > 80
  end,
}
```

## 檢查清單
- [ ] Lualine 正常顯示
- [ ] 模式指示器正常
- [ ] 檔案資訊顯示正確
- [ ] Git 整合功能正常
- [ ] LSP 狀態顯示正常
- [ ] 診斷資訊正常
- [ ] 自定義模組正常
- [ ] 主題配置正確

## 與其他模組的集成
- **Git 整合**: 顯示分支和變更統計
- **LSP 系統**: 顯示 LSP 狀態和診斷
- **檔案管理**: 與 nvim-tree 等擴展整合
- **主題系統**: 配合整體色彩主題