# 1.1 套件管理器設置企劃書 - lazy.nvim

## 專案概覽
建立現代化的 Neovim 套件管理基礎，使用 lazy.nvim 作為核心套件管理器，實現模組化載入和效能優化。

## 目標與預期成果
- ✅ 建立 lazy.nvim 套件管理系統
- ✅ 實現套件的 lazy loading 機制
- ✅ 建立模組化配置結構
- ✅ 優化 Neovim 啟動時間
- ✅ 為後續套件安裝建立基礎

## 前置需求
- Neovim 0.8+ 版本
- Git (用於套件下載)
- 現有的基本配置 (`lua/core/` 模組)

## 實施步驟

### 步驟 1: 建立 lazy.nvim 引導載入器
**位置**: `lua/plugins/init.lua`

```lua
-- lazy.nvim 自動安裝和初始化
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git",
    "clone",
    "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)

-- 初始化 lazy.nvim
require("lazy").setup({
  -- 套件列表將在此處定義
}, {
  ui = {
    -- 使用 unicode 圖示
    icons = vim.g.have_nerd_font and {} or {
      cmd = "⌘",
      config = "🛠",
      event = "📅",
      ft = "📂",
      init = "⚙",
      keys = "🗝",
      plugin = "🔌",
      runtime = "💻",
      require = "🌙",
      source = "📄",
      start = "🚀",
      task = "📋",
      lazy = "💤 ",
    },
  },
})
```

### 步驟 2: 更新主配置文件
**位置**: `init.lua`

```lua
-- Leader key 設置必須在套件載入前
vim.g.mapleader = ' '
vim.g.maplocalleader = ' '

-- 載入核心配置
require('core.options')
require('core.keymaps')

-- 載入套件管理器
require('plugins.init')
```

### 步驟 3: 建立套件配置目錄結構
```
lua/plugins/
├── init.lua              # lazy.nvim 主配置
├── lsp/                  # LSP 相關套件
├── completion/           # 自動完成相關
├── ui/                   # 介面相關套件
├── git/                  # Git 整合套件
├── treesitter.lua        # 語法高亮
└── dap/                  # 除錯工具
```

### 步驟 4: 建立套件模組載入機制
**位置**: `lua/plugins/init.lua` (更新版本)

```lua
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git",
    "clone",
    "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)

-- 收集所有套件配置
local plugins = {}

-- 自動載入 plugins 目錄下的所有 lua 檔案
local plugin_files = vim.fn.glob(vim.fn.stdpath('config') .. '/lua/plugins/**/*.lua', false, true)
for _, file in ipairs(plugin_files) do
  local module_name = file:match('.*/lua/plugins/(.*)%.lua$')
  if module_name and module_name ~= 'init' then
    local module_path = 'plugins.' .. module_name:gsub('/', '.')
    local ok, plugin_config = pcall(require, module_path)
    if ok and type(plugin_config) == 'table' then
      if plugin_config[1] then
        -- 如果是套件列表
        vim.list_extend(plugins, plugin_config)
      else
        -- 如果是單個套件配置
        table.insert(plugins, plugin_config)
      end
    end
  end
end

require("lazy").setup(plugins, {
  ui = {
    icons = vim.g.have_nerd_font and {} or {
      cmd = "⌘",
      config = "🛠",
      event = "📅",
      ft = "📂",
      init = "⚙",
      keys = "🗝",
      plugin = "🔌",
      runtime = "💻",
      require = "🌙",
      source = "📄",
      start = "🚀",
      task = "📋",
      lazy = "💤 ",
    },
  },
  performance = {
    rtp = {
      -- 停用一些不需要的內建套件
      disabled_plugins = {
        "gzip",
        "tarPlugin",
        "tohtml",
        "tutor",
        "zipPlugin",
      },
    },
  },
})
```

### 步驟 5: 建立測試套件配置
**位置**: `lua/plugins/ui/which-key.lua` (範例套件)

```lua
-- which-key.nvim - 按鍵提示套件
return {
  "folke/which-key.nvim",
  event = "VimEnter",
  config = function()
    require("which-key").setup({
      plugins = { spelling = true },
      defaults = {},
    })
  end,
}
```

## 驗證與測試

### 基本功能驗證
1. **啟動測試**:
   ```bash
   nvim --startuptime startup.log
   # 檢查啟動時間是否合理 (< 100ms)
   ```

2. **套件管理介面測試**:
   ```vim
   :Lazy
   # 應該顯示 lazy.nvim 管理介面
   ```

3. **套件安裝測試**:
   ```vim
   :Lazy install
   # 安裝所有已配置的套件
   ```

### 效能驗證
- 啟動時間應 < 100ms
- 記憶體使用應保持合理
- 沒有錯誤訊息或警告

## 按鍵映射

### 新增套件管理相關按鍵
**位置**: `lua/core/keymaps.lua` (新增)

```lua
-- 套件管理
vim.keymap.set("n", "<leader>pm", ":Lazy<cr>", { desc = "開啟套件管理器" })
vim.keymap.set("n", "<leader>pi", ":Lazy install<cr>", { desc = "安裝套件" })
vim.keymap.set("n", "<leader>pu", ":Lazy update<cr>", { desc = "更新套件" })
vim.keymap.set("n", "<leader>pc", ":Lazy clean<cr>", { desc = "清理套件" })
vim.keymap.set("n", "<leader>ps", ":Lazy sync<cr>", { desc = "同步套件" })
```

## 常見問題與解決方案

### Q1: lazy.nvim 下載失敗
**原因**: 網路連線問題或 Git 配置問題
**解決方案**:
```bash
# 手動下載 lazy.nvim
git clone https://github.com/folke/lazy.nvim.git ~/.local/share/nvim/lazy/lazy.nvim
```

### Q2: 套件載入錯誤
**原因**: 配置語法錯誤或路徑問題
**解決方案**:
1. 檢查 Lua 語法: `:luafile %`
2. 檢查錯誤訊息: `:messages`
3. 重新載入配置: `<leader>sv`

### Q3: 啟動時間過長
**原因**: 套件載入策略不當
**解決方案**:
- 使用 `event` 或 `ft` 進行 lazy loading
- 檢查 `performance.disabled_plugins` 設置
- 使用 `:Lazy profile` 分析載入時間

## 後續步驟
完成此階段後，將為以下套件安裝建立基礎：
1. LSP 系統 (mason.nvim + nvim-lspconfig)
2. 自動完成 (nvim-cmp)
3. 檔案搜尋 (telescope.nvim)
4. 語法高亮 (nvim-treesitter)

## 回滾方案
如果遇到問題，可以：
1. 移除 `lua/plugins/` 目錄
2. 從 `init.lua` 中移除 `require('plugins.init')`
3. 刪除 `~/.local/share/nvim/lazy/` 目錄
4. 重新啟動 Neovim

## 檢查清單
- [ ] lazy.nvim 自動安裝成功
- [ ] 套件管理介面可正常開啟
- [ ] 啟動時間 < 100ms
- [ ] 無錯誤訊息
- [ ] 按鍵映射正常運作
- [ ] 模組化載入機制運作正常