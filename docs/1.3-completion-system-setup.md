# 1.3 自動完成系統設置企劃書 - nvim-cmp

## 專案概覽
建立智能的自動完成系統，提供多源補全、snippet 展開、LSP 整合和自定義補全源，大幅提升編程效率。

## 目標與預期成果
- ✅ 智能 LSP 代碼補全
- ✅ 檔案路徑自動完成
- ✅ 緩衝區內容補全
- ✅ Snippet 系統整合
- ✅ 自定義補全源支援
- ✅ 智能排序和過濾

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成 1.2 LSP 系統設置
- Neovim 0.8+ 版本

## 核心套件組合
1. **nvim-cmp** - 補全引擎核心
2. **LuaSnip** - snippet 引擎
3. **cmp-nvim-lsp** - LSP 補全源
4. **cmp-buffer** - 緩衝區補全源
5. **cmp-path** - 檔案路徑補全源
6. **cmp-cmdline** - 命令列補全源
7. **cmp_luasnip** - LuaSnip 補全源
8. **friendly-snippets** - 預定義 snippet 集合

## 實施步驟

### 步驟 1: 核心補全引擎設置
**位置**: `lua/plugins/completion.lua`

```lua
return {
  "hrsh7th/nvim-cmp",
  version = false, -- 最新功能
  event = "InsertEnter",
  dependencies = {
    "hrsh7th/cmp-nvim-lsp",
    "hrsh7th/cmp-buffer",
    "hrsh7th/cmp-path",
    "hrsh7th/cmp-cmdline",
    "saadparwaiz1/cmp_luasnip",
    {
      "L3MON4D3/LuaSnip",
      build = (function()
        if vim.fn.has "win32" == 1 or vim.fn.executable "make" == 0 then
          return
        end
        return "make install_jsregexp"
      end)(),
      dependencies = {
        {
          "rafamadriz/friendly-snippets",
          config = function()
            require("luasnip.loaders.from_vscode").lazy_load()
          end,
        },
      },
    },
  },
  config = function()
    local cmp = require("cmp")
    local luasnip = require("luasnip")

    -- 檢查游標前是否有文字
    local has_words_before = function()
      unpack = unpack or table.unpack
      local line, col = unpack(vim.api.nvim_win_get_cursor(0))
      return col ~= 0 and vim.api.nvim_buf_get_lines(0, line - 1, line, true)[1]:sub(col, col):match("%s") == nil
    end

    cmp.setup({
      snippet = {
        expand = function(args)
          luasnip.lsp_expand(args.body)
        end,
      },
      
      mapping = cmp.mapping.preset.insert({
        -- 基本導航
        ["<C-n>"] = cmp.mapping.select_next_item(),
        ["<C-p>"] = cmp.mapping.select_prev_item(),
        ["<C-d>"] = cmp.mapping.scroll_docs(-4),
        ["<C-f>"] = cmp.mapping.scroll_docs(4),
        ["<C-Space>"] = cmp.mapping.complete(),
        ["<C-e>"] = cmp.mapping.abort(),
        
        -- 確認選擇
        ["<CR>"] = cmp.mapping({
          i = function(fallback)
            if cmp.visible() and cmp.get_active_entry() then
              cmp.confirm({ behavior = cmp.ConfirmBehavior.Replace, select = false })
            else
              fallback()
            end
          end,
          s = cmp.mapping.confirm({ select = true }),
          c = cmp.mapping.confirm({ behavior = cmp.ConfirmBehavior.Replace, select = true }),
        }),
        
        -- Tab 智能處理
        ["<Tab>"] = cmp.mapping(function(fallback)
          if cmp.visible() then
            cmp.select_next_item()
          elseif luasnip.expand_or_locally_jumpable() then
            luasnip.expand_or_jump()
          elseif has_words_before() then
            cmp.complete()
          else
            fallback()
          end
        end, { "i", "s" }),
        
        ["<S-Tab>"] = cmp.mapping(function(fallback)
          if cmp.visible() then
            cmp.select_prev_item()
          elseif luasnip.locally_jumpable(-1) then
            luasnip.jump(-1)
          else
            fallback()
          end
        end, { "i", "s" }),
      }),

      sources = cmp.config.sources({
        { name = "nvim_lsp", priority = 1000 },
        { name = "luasnip", priority = 750 },
        { name = "buffer", priority = 500 },
        { name = "path", priority = 250 },
      }),

      formatting = {
        fields = { "kind", "abbr", "menu" },
        format = function(entry, vim_item)
          local kind_icons = {
            Text = "󰉿",
            Method = "󰆧",
            Function = "󰊕",
            Constructor = "",
            Field = "󰜢",
            Variable = "󰀫",
            Class = "󰠱",
            Interface = "",
            Module = "",
            Property = "󰜢",
            Unit = "󰑭",
            Value = "󰎠",
            Enum = "",
            Keyword = "󰌋",
            Snippet = "",
            Color = "󰏘",
            File = "󰈙",
            Reference = "󰈇",
            Folder = "󰉋",
            EnumMember = "",
            Constant = "󰏿",
            Struct = "󰙅",
            Event = "",
            Operator = "󰆕",
            TypeParameter = "",
          }

          vim_item.kind = string.format('%s %s', kind_icons[vim_item.kind], vim_item.kind)
          vim_item.menu = ({
            nvim_lsp = "[LSP]",
            luasnip = "[Snippet]",
            buffer = "[Buffer]",
            path = "[Path]",
          })[entry.source.name]
          
          return vim_item
        end,
      },

      experimental = {
        ghost_text = {
          hl_group = "CmpGhostText",
        },
      },

      sorting = {
        priority_weight = 2,
        comparators = {
          cmp.config.compare.offset,
          cmp.config.compare.exact,
          cmp.config.compare.score,
          cmp.config.compare.recently_used,
          cmp.config.compare.locality,
          cmp.config.compare.kind,
          cmp.config.compare.sort_text,
          cmp.config.compare.length,
          cmp.config.compare.order,
        },
      },
    })

    -- 檔案類型特定設置
    cmp.setup.filetype('gitcommit', {
      sources = cmp.config.sources({
        { name = 'buffer' },
      })
    })

    -- 命令列模式補全
    cmp.setup.cmdline({ '/', '?' }, {
      mapping = cmp.mapping.preset.cmdline(),
      sources = {
        { name = 'buffer' }
      }
    })

    cmp.setup.cmdline(':', {
      mapping = cmp.mapping.preset.cmdline(),
      sources = cmp.config.sources({
        { name = 'path' }
      }, {
        { name = 'cmdline' }
      })
    })
  end,
}
```

### 步驟 2: LuaSnip 配置和自定義 Snippets
**位置**: `lua/plugins/luasnip.lua`

```lua
return {
  "L3MON4D3/LuaSnip",
  build = (function()
    if vim.fn.has "win32" == 1 or vim.fn.executable "make" == 0 then
      return
    end
    return "make install_jsregexp"
  end)(),
  dependencies = {
    "rafamadriz/friendly-snippets",
    config = function()
      require("luasnip.loaders.from_vscode").lazy_load()
    end,
  },
  config = function()
    local luasnip = require("luasnip")
    local s = luasnip.snippet
    local t = luasnip.text_node
    local i = luasnip.insert_node
    local f = luasnip.function_node

    -- LuaSnip 設置
    luasnip.config.setup({
      history = true,
      updateevents = "TextChanged,TextChangedI",
      enable_autosnippets = true,
      ext_opts = {
        [require("luasnip.util.types").choiceNode] = {
          active = {
            virt_text = { { "choiceNode", "Comment" } },
          },
        },
      },
    })

    -- 自定義 Snippets
    luasnip.add_snippets("lua", {
      s("fn", {
        t("local function "), i(1, "name"), t("("), i(2), t(")"),
        t({ "", "  " }), i(3),
        t({ "", "end" })
      }),
      
      s("req", {
        t("local "), i(1, "module"), t(" = require('"), i(2), t("')")
      }),
      
      s("if", {
        t("if "), i(1, "condition"), t(" then"),
        t({ "", "  " }), i(2),
        t({ "", "end" })
      }),
    })

    luasnip.add_snippets("python", {
      s("def", {
        t("def "), i(1, "function_name"), t("("), i(2), t("):"),
        t({ "", "    " }), i(3, "pass")
      }),
      
      s("class", {
        t("class "), i(1, "ClassName"), t("("), i(2, "object"), t("):"),
        t({ "", "    def __init__(self", }), i(3), t("):"),
        t({ "", "        " }), i(4, "pass")
      }),
      
      s("ifmain", {
        t({ "if __name__ == '__main__':", "    " }), i(1, "main()")
      }),
    })

    luasnip.add_snippets("javascript", {
      s("fn", {
        t("function "), i(1, "name"), t("("), i(2), t(") {"),
        t({ "", "  " }), i(3),
        t({ "", "}" })
      }),
      
      s("arrow", {
        t("const "), i(1, "name"), t(" = ("), i(2), t(") => {"),
        t({ "", "  " }), i(3),
        t({ "", "}" })
      }),
      
      s("log", {
        t("console.log("), i(1), t(")")
      }),
    })

    -- 按鍵映射
    vim.keymap.set({"i"}, "<C-K>", function() luasnip.expand() end, {silent = true})
    vim.keymap.set({"i", "s"}, "<C-L>", function() luasnip.jump( 1) end, {silent = true})
    vim.keymap.set({"i", "s"}, "<C-J>", function() luasnip.jump(-1) end, {silent = true})

    vim.keymap.set({"i", "s"}, "<C-E>", function()
      if luasnip.choice_active() then
        luasnip.change_choice(1)
      end
    end, {silent = true})
  end,
}
```

### 步驟 3: LSP 整合更新
**位置**: `lua/plugins/lsp.lua` (更新 capabilities)

```lua
-- 在 lspconfig.lua 中更新 capabilities 設置
local capabilities = vim.lsp.protocol.make_client_capabilities()
capabilities = require('cmp_nvim_lsp').default_capabilities(capabilities)

-- 增強 LSP 補全能力
capabilities.textDocument.completion.completionItem = {
  documentationFormat = { "markdown", "plaintext" },
  snippetSupport = true,
  preselectSupport = true,
  insertReplaceSupport = true,
  labelDetailsSupport = true,
  deprecatedSupport = true,
  commitCharactersSupport = true,
  tagSupport = { valueSet = { 1 } },
  resolveSupport = {
    properties = {
      "documentation",
      "detail",
      "additionalTextEdits",
    },
  },
}
```

### 步驟 4: 額外補全源
**位置**: `lua/plugins/extra-sources.lua`

```lua
return {
  -- 表情符號補全
  {
    "hrsh7th/cmp-emoji",
    dependencies = "nvim-cmp",
    config = function()
      require("cmp").setup({
        sources = {
          { name = "emoji" },
        },
      })
    end,
  },

  -- 計算器補全
  {
    "hrsh7th/cmp-calc",
    dependencies = "nvim-cmp",
    config = function()
      require("cmp").setup({
        sources = {
          { name = "calc" },
        },
      })
    end,
  },

  -- Git 補全
  {
    "petertriho/cmp-git",
    dependencies = "nvim-cmp",
    ft = "gitcommit",
    config = function()
      require("cmp_git").setup()
      require("cmp").setup.filetype("gitcommit", {
        sources = {
          { name = "git" },
          { name = "buffer" },
        },
      })
    end,
  },
}
```

## 驗證與測試

### 基本功能測試
1. **LSP 補全測試**:
   ```lua
   -- 在 .lua 檔案中輸入
   vim.lsp.buf.hover() -- 應該顯示 LSP 補全
   ```

2. **Snippet 測試**:
   ```lua
   -- 輸入 "fn" 然後按 Tab
   -- 應該展開為函數 template
   ```

3. **路徑補全測試**:
   ```lua
   -- 輸入 require("./
   -- 應該顯示當前目錄的檔案
   ```

### 高級功能測試
```lua
-- 測試智能排序
local function test_completion()
  -- 當輸入 "vim." 時應該優先顯示 vim API
  vim.api.nvim_buf_get_lines()
end
```

## 按鍵映射總結

### Insert 模式
- `<C-n>` / `<C-p>` - 選擇下一個/上一個項目
- `<Tab>` / `<S-Tab>` - 智能 Tab (補全/snippet 跳轉)
- `<CR>` - 確認選擇
- `<C-Space>` - 手動觸發補全
- `<C-e>` - 取消補全

### Snippet 導航
- `<C-K>` - 展開 snippet
- `<C-L>` - 跳轉到下一個 snippet 位置
- `<C-J>` - 跳轉到上一個 snippet 位置
- `<C-E>` - 在 choice node 中切換選項

## 自定義配置選項

### 外觀自定義
```lua
-- 在 cmp.lua 中調整
formatting = {
  format = function(entry, vim_item)
    -- 自定義圖示和樣式
    vim_item.kind = custom_kind_icons[vim_item.kind]
    vim_item.menu = custom_menu_names[entry.source.name]
    return vim_item
  end,
},
```

### 行為自定義
```lua
-- 調整補全行為
completion = {
  autocomplete = { require("cmp.types").cmp.TriggerEvent.TextChanged },
  completeopt = "menu,menuone,noselect",
},
```

## 常見問題與解決方案

### Q1: 補全不出現
**檢查項目**:
1. `:CmpStatus` - 檢查 cmp 狀態
2. 確認 LSP 已啟動: `:LspInfo`
3. 檢查 sources 配置

### Q2: Snippet 不展開
**解決方案**:
```vim
:lua print(require("luasnip").available())
# 檢查可用的 snippets
```

### Q3: 補全性能問題
**優化方案**:
```lua
-- 限制補全項目數量
completion = {
  keyword_length = 2,
  max_item_count = 20,
},
```

### Q4: 某些檔案類型無補全
**解決方案**:
```lua
-- 為特定檔案類型添加補全源
cmp.setup.filetype('markdown', {
  sources = cmp.config.sources({
    { name = 'buffer' },
    { name = 'path' },
  })
})
```

## 效能優化

1. **延遲載入**: 只在 Insert 模式載入
2. **源優先級**: 合理設置 source priority
3. **過濾配置**: 使用 keyword_length 減少不必要的觸發
4. **記憶體管理**: 定期清理 snippet cache

## 進階功能

### 動態 Snippets
```lua
-- 根據檔案內容動態生成 snippets
luasnip.add_snippets("lua", {
  s("modreq", {
    f(function()
      local filename = vim.fn.expand("%:t:r")
      return "local " .. filename .. " = require('" .. filename .. "')"
    end),
  }),
})
```

### 條件式 Snippets
```lua
-- 只在特定條件下可用的 snippets
luasnip.add_snippets("lua", {
  s("test", {
    t("-- This is a test function"),
  }, {
    condition = function()
      return vim.bo.filetype == "lua"
    end,
  }),
})
```

## 檢查清單
- [ ] nvim-cmp 正常運作
- [ ] LSP 補全功能正常
- [ ] Snippet 展開和跳轉正常
- [ ] 路徑補全功能正常
- [ ] 命令列補全正常
- [ ] 自定義 snippets 載入成功
- [ ] 按鍵映射設置完成
- [ ] 效能表現良好

## 與其他模組的集成
- **LSP 系統**: 提供智能代碼補全
- **Telescope**: 可用於 snippet 搜尋
- **Treesitter**: 提供更精確的語法感知補全