# 1.4 模糊搜尋系統設置企劃書 - telescope.nvim

## 專案概覽
建立強大的模糊搜尋和導航系統，提供檔案搜尋、內容搜尋、LSP 符號導航、命令面板等功能，大幅提升開發效率。

## 目標與預期成果
- ✅ 快速檔案搜尋和開啟
- ✅ 即時內容搜尋 (live grep)
- ✅ LSP 符號和參考搜尋
- ✅ Git 整合搜尋
- ✅ 緩衝區和歷史管理
- ✅ 自定義搜尋器和擴展

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成 1.2 LSP 系統設置 (可選，但建議)
- ripgrep (rg) - 用於內容搜尋
- fd 或 find - 用於檔案搜尋
- Git (用於 Git 相關功能)

## 核心套件組合
1. **telescope.nvim** - 模糊搜尋器核心
2. **plenary.nvim** - Lua 實用函數庫
3. **telescope-fzf-native.nvim** - FZF 演算法加速
4. **telescope-ui-select.nvim** - 替代 vim.ui.select
5. **telescope-file-browser.nvim** - 檔案瀏覽器擴展

## 實施步驟

### 步驟 1: 核心 Telescope 設置
**位置**: `lua/plugins/telescope.lua`

```lua
return {
  "nvim-telescope/telescope.nvim",
  branch = "0.1.x",
  dependencies = {
    "nvim-lua/plenary.nvim",
    {
      "nvim-telescope/telescope-fzf-native.nvim",
      build = "make",
      cond = function()
        return vim.fn.executable "make" == 1
      end,
    },
    { "nvim-telescope/telescope-ui-select.nvim" },
    { "nvim-tree/nvim-web-devicons", enabled = vim.g.have_nerd_font },
  },
  config = function()
    local telescope = require("telescope")
    local actions = require("telescope.actions")
    local action_layout = require("telescope.actions.layout")

    telescope.setup({
      defaults = {
        prompt_prefix = "🔍 ",
        selection_caret = "❯ ",
        path_display = { "truncate" },
        file_ignore_patterns = {
          "%.git/",
          "node_modules/",
          "%.npm/",
          "%.next/",
          "dist/",
          "build/",
          "%.o",
          "%.a",
          "%.out",
          "%.class",
          "%.pdf",
          "%.mkv",
          "%.mp4",
          "%.zip",
        },
        mappings = {
          i = {
            ["<C-n>"] = actions.move_selection_next,
            ["<C-p>"] = actions.move_selection_previous,
            ["<C-c>"] = actions.close,
            ["<Down>"] = actions.move_selection_next,
            ["<Up>"] = actions.move_selection_previous,
            ["<CR>"] = actions.select_default,
            ["<C-x>"] = actions.select_horizontal,
            ["<C-v>"] = actions.select_vertical,
            ["<C-t>"] = actions.select_tab,
            ["<C-u>"] = actions.preview_scrolling_up,
            ["<C-d>"] = actions.preview_scrolling_down,
            ["<PageUp>"] = actions.results_scrolling_up,
            ["<PageDown>"] = actions.results_scrolling_down,
            ["<Tab>"] = actions.toggle_selection + actions.move_selection_worse,
            ["<S-Tab>"] = actions.toggle_selection + actions.move_selection_better,
            ["<C-q>"] = actions.send_to_qflist + actions.open_qflist,
            ["<M-q>"] = actions.send_selected_to_qflist + actions.open_qflist,
            ["<C-l>"] = actions.complete_tag,
            ["<C-_>"] = actions.which_key, -- keys from pressing <C-/>
            ["<M-p>"] = action_layout.toggle_preview,
          },
          n = {
            ["<esc>"] = actions.close,
            ["<CR>"] = actions.select_default,
            ["<C-x>"] = actions.select_horizontal,
            ["<C-v>"] = actions.select_vertical,
            ["<C-t>"] = actions.select_tab,
            ["<Tab>"] = actions.toggle_selection + actions.move_selection_worse,
            ["<S-Tab>"] = actions.toggle_selection + actions.move_selection_better,
            ["<C-q>"] = actions.send_to_qflist + actions.open_qflist,
            ["<M-q>"] = actions.send_selected_to_qflist + actions.open_qflist,
            ["j"] = actions.move_selection_next,
            ["k"] = actions.move_selection_previous,
            ["H"] = actions.move_to_top,
            ["M"] = actions.move_to_middle,
            ["L"] = actions.move_to_bottom,
            ["<Down>"] = actions.move_selection_next,
            ["<Up>"] = actions.move_selection_previous,
            ["gg"] = actions.move_to_top,
            ["G"] = actions.move_to_bottom,
            ["<C-u>"] = actions.preview_scrolling_up,
            ["<C-d>"] = actions.preview_scrolling_down,
            ["<PageUp>"] = actions.results_scrolling_up,
            ["<PageDown>"] = actions.results_scrolling_down,
            ["?"] = actions.which_key,
            ["<M-p>"] = action_layout.toggle_preview,
          },
        },
      },
      pickers = {
        find_files = {
          theme = "dropdown",
          previewer = false,
          hidden = true,
          find_command = { "rg", "--files", "--hidden", "--glob", "!**/.git/*" },
        },
        live_grep = {
          additional_args = function(opts)
            return {"--hidden"}
          end
        },
        buffers = {
          theme = "dropdown",
          previewer = false,
          initial_mode = "normal",
          mappings = {
            i = {
              ["<C-d>"] = actions.delete_buffer,
            },
            n = {
              ["dd"] = actions.delete_buffer,
            },
          },
        },
        planets = {
          show_pluto = true,
          show_moon = true,
        },
        colorscheme = {
          enable_preview = true,
        },
        lsp_references = {
          theme = "dropdown",
          initial_mode = "normal",
        },
        lsp_definitions = {
          theme = "dropdown",
          initial_mode = "normal",
        },
        lsp_declarations = {
          theme = "dropdown",
          initial_mode = "normal",
        },
        lsp_implementations = {
          theme = "dropdown",
          initial_mode = "normal",
        },
      },
      extensions = {
        ["ui-select"] = {
          require("telescope.themes").get_dropdown(),
        },
      },
    })

    -- 載入擴展
    pcall(require("telescope").load_extension, "fzf")
    pcall(require("telescope").load_extension, "ui-select")

    -- 自定義函數
    local builtin = require("telescope.builtin")

    -- 智能檔案搜尋 (優先 git files，否則 find files)
    local function find_files_smart()
      local is_git_repo = vim.fn.system("git rev-parse --is-inside-work-tree 2>/dev/null"):match("true")
      if is_git_repo then
        builtin.git_files({ show_untracked = true })
      else
        builtin.find_files()
      end
    end

    -- 搜尋配置檔案
    local function find_config_files()
      builtin.find_files({
        prompt_title = "< Config Files >",
        cwd = vim.fn.stdpath("config"),
        hidden = true,
      })
    end

    -- 搜尋 Neovim 配置
    local function grep_config()
      builtin.live_grep({
        prompt_title = "< Search Config >",
        cwd = vim.fn.stdpath("config"),
      })
    end

    -- 按鍵映射
    local map = vim.keymap.set

    -- 檔案相關
    map("n", "<leader>ff", find_files_smart, { desc = "搜尋檔案" })
    map("n", "<leader>fF", builtin.find_files, { desc = "搜尋所有檔案" })
    map("n", "<leader>fg", builtin.live_grep, { desc = "Live Grep" })
    map("n", "<leader>fw", builtin.grep_string, { desc = "搜尋當前單詞" })
    map("n", "<leader>fr", builtin.oldfiles, { desc = "最近檔案" })
    map("n", "<leader>fc", find_config_files, { desc = "配置檔案" })
    map("n", "<leader>fC", grep_config, { desc = "搜尋配置" })

    -- 緩衝區和標籤
    map("n", "<leader>fb", builtin.buffers, { desc = "緩衝區列表" })
    map("n", "<leader>ft", builtin.help_tags, { desc = "幫助標籤" })
    map("n", "<leader>fm", builtin.marks, { desc = "標記" })
    map("n", "<leader>fj", builtin.jumplist, { desc = "跳轉列表" })

    -- LSP 相關
    map("n", "<leader>ls", builtin.lsp_document_symbols, { desc = "文件符號" })
    map("n", "<leader>lS", builtin.lsp_dynamic_workspace_symbols, { desc = "工作區符號" })
    map("n", "gr", builtin.lsp_references, { desc = "查找引用" })
    map("n", "gd", builtin.lsp_definitions, { desc = "跳轉定義" })
    map("n", "gD", builtin.lsp_declarations, { desc = "跳轉聲明" })
    map("n", "gi", builtin.lsp_implementations, { desc = "跳轉實現" })

    -- Git 相關
    map("n", "<leader>gf", builtin.git_files, { desc = "Git 檔案" })
    map("n", "<leader>gs", builtin.git_status, { desc = "Git 狀態" })
    map("n", "<leader>gb", builtin.git_branches, { desc = "Git 分支" })
    map("n", "<leader>gc", builtin.git_commits, { desc = "Git 提交" })
    map("n", "<leader>gC", builtin.git_bcommits, { desc = "緩衝區提交" })

    -- 其他功能
    map("n", "<leader>fk", builtin.keymaps, { desc = "按鍵映射" })
    map("n", "<leader>fh", builtin.command_history, { desc = "命令歷史" })
    map("n", "<leader>f:", builtin.commands, { desc = "命令" })
    map("n", "<leader>f/", builtin.current_buffer_fuzzy_find, { desc = "當前緩衝區搜尋" })
    map("n", "<leader>f?", builtin.search_history, { desc = "搜尋歷史" })

    -- 快速訪問
    map("n", "<leader><space>", builtin.buffers, { desc = "切換緩衝區" })
    map("n", "<C-p>", find_files_smart, { desc = "快速檔案搜尋" })
  end,
}
```

### 步驟 2: 增強搜尋功能
**位置**: `lua/plugins/telescope-extensions.lua`

```lua
return {
  -- 檔案瀏覽器擴展
  {
    "nvim-telescope/telescope-file-browser.nvim",
    dependencies = { "telescope.nvim", "nvim-lua/plenary.nvim" },
    config = function()
      require("telescope").load_extension("file_browser")
      
      vim.keymap.set("n", "<leader>fe", function()
        require("telescope").extensions.file_browser.file_browser({
          path = "%:p:h",
          cwd = vim.fn.expand("%:p:h"),
          respect_gitignore = false,
          hidden = true,
          grouped = true,
          previewer = false,
          initial_mode = "normal",
          layout_config = { height = 40 }
        })
      end, { desc = "檔案瀏覽器" })
    end,
  },

  -- 專案管理
  {
    "ahmedkhalf/project.nvim",
    opts = {
      manual_mode = false,
    },
    event = "VeryLazy",
    config = function(_, opts)
      require("project_nvim").setup(opts)
      require("telescope").load_extension("projects")
      
      vim.keymap.set("n", "<leader>fp", function()
        require("telescope").extensions.projects.projects({})
      end, { desc = "專案" })
    end,
    keys = {
      { "<leader>fp", "<Cmd>Telescope projects<CR>", desc = "專案" },
    },
  },

  -- 符號大綱
  {
    "stevearc/aerial.nvim",
    opts = {
      backends = { "treesitter", "lsp", "markdown", "man" },
      show_guides = true,
      layout = {
        min_width = 20,
        default_direction = "prefer_right",
      },
      guides = {
        mid_item = "├─",
        last_item = "└─",
        nested_top = "│ ",
        whitespace = "  ",
      },
    },
    dependencies = {
      "nvim-treesitter/nvim-treesitter",
      "nvim-tree/nvim-web-devicons",
    },
    config = function(_, opts)
      require("aerial").setup(opts)
      require("telescope").load_extension("aerial")
      
      vim.keymap.set("n", "<leader>fo", function()
        require("telescope").extensions.aerial.aerial()
      end, { desc = "符號大綱" })
    end,
  },
}
```

### 步驟 3: 自定義搜尋器
**位置**: `lua/plugins/telescope-custom.lua`

```lua
return {
  "nvim-telescope/telescope.nvim",
  dependencies = {
    "nvim-lua/plenary.nvim",
  },
  config = function()
    local telescope = require("telescope")
    local pickers = require("telescope.pickers")
    local finders = require("telescope.finders")
    local conf = require("telescope.config").values
    local actions = require("telescope.actions")
    local action_state = require("telescope.actions.state")

    -- 自定義搜尋器：搜尋 TODO 註解
    local function search_todos()
      pickers.new({}, {
        prompt_title = "TODO 搜尋",
        finder = finders.new_oneshot_job({
          "rg",
          "--vimgrep",
          "--no-heading",
          "--with-filename",
          "--line-number",
          "--column",
          "TODO|FIXME|HACK|BUG|NOTE",
        }, {
          entry_maker = function(entry)
            local filename, line, col, text = string.match(entry, "([^:]+):(%d+):(%d+):(.*)")
            return {
              value = entry,
              display = string.format("%s:%s - %s", filename, line, text:gsub("^%s+", "")),
              ordinal = entry,
              filename = filename,
              lnum = tonumber(line),
              col = tonumber(col),
              text = text,
            }
          end,
        }),
        sorter = conf.generic_sorter({}),
        previewer = conf.grep_previewer({}),
        attach_mappings = function(prompt_bufnr, map)
          actions.select_default:replace(function()
            actions.close(prompt_bufnr)
            local selection = action_state.get_selected_entry()
            vim.cmd("edit " .. selection.filename)
            vim.api.nvim_win_set_cursor(0, { selection.lnum, selection.col - 1 })
          end)
          return true
        end,
      }):find()
    end

    -- 自定義搜尋器：搜尋套件
    local function search_plugins()
      local plugins_path = vim.fn.stdpath("config") .. "/lua/plugins"
      pickers.new({}, {
        prompt_title = "套件配置",
        finder = finders.new_oneshot_job({
          "find",
          plugins_path,
          "-name",
          "*.lua",
          "-type",
          "f",
        }, {
          entry_maker = function(entry)
            local relative_path = entry:gsub(vim.fn.stdpath("config") .. "/", "")
            return {
              value = entry,
              display = relative_path,
              ordinal = relative_path,
              path = entry,
            }
          end,
        }),
        sorter = conf.generic_sorter({}),
        previewer = conf.file_previewer({}),
      }):find()
    end

    -- 自定義搜尋器：搜尋色彩主題
    local function search_colorschemes()
      local colors = vim.fn.getcompletion("", "color")
      pickers.new({}, {
        prompt_title = "色彩主題",
        finder = finders.new_table({
          results = colors,
        }),
        sorter = conf.generic_sorter({}),
        attach_mappings = function(prompt_bufnr, map)
          actions.select_default:replace(function()
            local selection = action_state.get_selected_entry()
            actions.close(prompt_bufnr)
            vim.cmd("colorscheme " .. selection[1])
          end)
          return true
        end,
      }):find()
    end

    -- 自定義搜尋器：Neovim 選項
    local function search_options()
      local options = {}
      for name, value in pairs(vim.o) do
        table.insert(options, {
          name = name,
          value = tostring(value),
          type = type(value),
        })
      end

      pickers.new({}, {
        prompt_title = "Neovim 選項",
        finder = finders.new_table({
          results = options,
          entry_maker = function(entry)
            return {
              value = entry,
              display = string.format("%-30s = %s (%s)", entry.name, entry.value, entry.type),
              ordinal = entry.name,
            }
          end,
        }),
        sorter = conf.generic_sorter({}),
        attach_mappings = function(prompt_bufnr, map)
          actions.select_default:replace(function()
            local selection = action_state.get_selected_entry()
            actions.close(prompt_bufnr)
            print(string.format("%s = %s", selection.value.name, selection.value.value))
          end)
          return true
        end,
      }):find()
    end

    -- 註冊自定義搜尋器
    vim.keymap.set("n", "<leader>ft", search_todos, { desc = "搜尋 TODO" })
    vim.keymap.set("n", "<leader>fp", search_plugins, { desc = "套件配置" })
    vim.keymap.set("n", "<leader>fT", search_colorschemes, { desc = "色彩主題" })
    vim.keymap.set("n", "<leader>fo", search_options, { desc = "Neovim 選項" })
  end,
}
```

### 步驟 4: 增強按鍵映射和工作流程
**位置**: `lua/core/keymaps.lua` (新增)

```lua
-- Telescope 相關快捷鍵
vim.keymap.set("n", "<leader>f", "", { desc = "+檔案/搜尋" })
vim.keymap.set("n", "<leader>g", "", { desc = "+Git" })
vim.keymap.set("n", "<leader>l", "", { desc = "+LSP" })

-- 工作流程快捷鍵
vim.keymap.set("n", "<leader>/", function()
  require("telescope.builtin").current_buffer_fuzzy_find()
end, { desc = "當前緩衝區搜尋" })

vim.keymap.set("n", "<leader>s", function()
  require("telescope.builtin").lsp_document_symbols()
end, { desc = "文件符號" })

-- 快速搜尋模式
vim.keymap.set("n", "<leader><leader>", function()
  require("telescope.builtin").resume()
end, { desc = "繼續上次搜尋" })
```

## 驗證與測試

### 基本功能測試
1. **檔案搜尋測試**:
   ```vim
   <leader>ff
   # 應該顯示專案中的檔案列表
   ```

2. **內容搜尋測試**:
   ```vim
   <leader>fg
   # 應該開啟 live grep 搜尋
   ```

3. **LSP 整合測試**:
   ```vim
   <leader>ls
   # 應該顯示當前檔案的符號
   ```

### 進階功能測試
```lua
-- 測試自定義搜尋器
vim.keymap.set("n", "<leader>ft", ":Telescope<space>")
-- 測試 TODO 搜尋、專案搜尋等功能
```

## 效能優化

### 搜尋最佳化
```lua
defaults = {
  -- 限制結果數量
  file_sorter = require("telescope.sorters").get_fuzzy_file,
  generic_sorter = require("telescope.sorters").get_generic_fuzzy_sorter,
  
  -- 使用更快的搜尋工具
  vimgrep_arguments = {
    "rg",
    "--color=never",
    "--no-heading",
    "--with-filename",
    "--line-number",
    "--column",
    "--smart-case",
    "--hidden", -- 搜尋隱藏檔案
    "--glob=!.git/", -- 忽略 .git 目錄
  },
}
```

### 記憶體優化
```lua
-- 限制預覽器大小
preview = {
  filesize_limit = 0.1, -- MB
  timeout = 250, -- ms
},
```

## 常見問題與解決方案

### Q1: ripgrep 未安裝
**解決方案**:
```bash
# Ubuntu/Debian
sudo apt install ripgrep

# macOS
brew install ripgrep

# Windows
choco install ripgrep
```

### Q2: 搜尋速度慢
**檢查項目**:
1. 確認 fzf-native 已編譯: `:checkhealth telescope`
2. 使用合適的 file_ignore_patterns
3. 限制搜尋範圍

### Q3: LSP 符號搜尋不工作
**解決方案**:
1. 確認 LSP 已啟動: `:LspInfo`
2. 檢查當前檔案類型是否支援
3. 重啟 LSP: `:LspRestart`

### Q4: Git 功能不可用
**解決方案**:
1. 確認在 Git 倉庫中
2. 檢查 Git 安裝: `git --version`
3. 檢查權限問題

## 進階配置

### 自定義主題
```lua
pickers = {
  find_files = {
    theme = "ivy", -- dropdown, cursor, ivy
  },
}
```

### 多專案工作流程
```lua
-- 專案特定設置
vim.api.nvim_create_autocmd("DirChanged", {
  callback = function()
    require("telescope.builtin").find_files({
      cwd = vim.fn.getcwd(),
    })
  end,
})
```

### 與其他套件整合
```lua
-- 與 nvim-tree 整合
vim.keymap.set("n", "<leader>nt", function()
  require("nvim-tree.api").tree.find_file()
end, { desc = "在 nvim-tree 中定位檔案" })
```

## 按鍵映射總結

### 檔案操作
- `<leader>ff` - 智能檔案搜尋
- `<leader>fF` - 所有檔案搜尋
- `<leader>fr` - 最近檔案
- `<leader>fb` - 緩衝區列表
- `<C-p>` - 快速檔案搜尋

### 內容搜尋
- `<leader>fg` - Live grep
- `<leader>fw` - 搜尋當前單詞
- `<leader>f/` - 當前緩衝區搜尋
- `<leader>/` - 當前緩衝區模糊搜尋

### LSP 整合
- `<leader>ls` - 文件符號
- `<leader>lS` - 工作區符號
- `gr` - 查找引用
- `gd` - 跳轉定義

### Git 整合
- `<leader>gf` - Git 檔案
- `<leader>gs` - Git 狀態
- `<leader>gb` - Git 分支
- `<leader>gc` - Git 提交

### 實用功能
- `<leader>fk` - 按鍵映射
- `<leader>fh` - 命令歷史
- `<leader>fc` - 配置檔案
- `<leader>ft` - TODO 搜尋

## 檢查清單
- [ ] Telescope 核心功能正常
- [ ] FZF native 編譯成功
- [ ] 檔案搜尋功能正常
- [ ] Live grep 功能正常
- [ ] LSP 整合功能正常
- [ ] Git 整合功能正常
- [ ] 自定義搜尋器正常
- [ ] 按鍵映射設置完成
- [ ] 效能表現良好

## 與其他模組的集成
- **LSP 系統**: 符號搜尋和導航
- **Git 整合**: 版本控制相關搜尋
- **檔案管理**: 與 nvim-tree 協同工作
- **專案管理**: 多專案間快速切換