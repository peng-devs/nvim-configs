# 2.3 é™¤éŒ¯æ”¯æ´ç³»çµ±è¨­ç½®ä¼åŠƒæ›¸ - nvim-dap

## å°ˆæ¡ˆæ¦‚è¦½
å»ºç«‹å®Œæ•´çš„é™¤éŒ¯ç³»çµ±ï¼Œæ”¯æ´å¤šç¨®ç¨‹å¼èªè¨€çš„æ–·é»é™¤éŒ¯ã€è®Šæ•¸æª¢è¦–ã€èª¿ç”¨å †ç–Šåˆ†æå’Œé™¤éŒ¯ä»‹é¢æ•´åˆã€‚

## ç›®æ¨™èˆ‡é æœŸæˆæœ
- âœ… Debug Adapter Protocol (DAP) æ”¯æ´
- âœ… æ–·é»ç®¡ç†å’Œæ¢ä»¶æ–·é»
- âœ… è®Šæ•¸æª¢è¦–å’Œå€¼ä¿®æ”¹
- âœ… èª¿ç”¨å †ç–Šç€è¦½
- âœ… é™¤éŒ¯æ§åˆ¶å°å’Œ REPL
- âœ… å¤šèªè¨€é™¤éŒ¯å™¨æ•´åˆ

## å‰ç½®éœ€æ±‚
- å·²å®Œæˆ 1.1 å¥—ä»¶ç®¡ç†å™¨è¨­ç½® (lazy.nvim)
- å°æ‡‰ç¨‹å¼èªè¨€çš„é™¤éŒ¯å™¨ (å¦‚ node, python, go ç­‰)
- ç·¨è­¯å¾Œçš„é™¤éŒ¯ç¬¦è™Ÿ (debug symbols)

## æ ¸å¿ƒå¥—ä»¶çµ„åˆ
1. **nvim-dap** - DAP å®¢æˆ¶ç«¯æ ¸å¿ƒ
2. **nvim-dap-ui** - é™¤éŒ¯ä»‹é¢
3. **nvim-dap-virtual-text** - è™›æ“¬æ–‡å­—é¡¯ç¤º
4. **mason-nvim-dap.nvim** - é™¤éŒ¯å™¨ç®¡ç†

## å¯¦æ–½æ­¥é©Ÿ

### æ­¥é©Ÿ 1: DAP æ ¸å¿ƒè¨­ç½®
**ä½ç½®**: `lua/plugins/dap/init.lua`

```lua
return {
  "mfussenegger/nvim-dap",
  dependencies = {
    "rcarriga/nvim-dap-ui",
    "theHamsta/nvim-dap-virtual-text",
    "jay-babu/mason-nvim-dap.nvim",
    "williamboman/mason.nvim",
  },
  config = function()
    local dap = require("dap")
    local dapui = require("dapui")

    -- é™¤éŒ¯å™¨åœ–ç¤ºè¨­ç½®
    vim.fn.sign_define('DapBreakpoint', {
      text = 'ğŸŸ¥',
      texthl = 'DapBreakpoint',
      linehl = 'DapBreakpoint',
      numhl = 'DapBreakpoint'
    })
    vim.fn.sign_define('DapBreakpointCondition', {
      text = 'ğŸŸ¡',
      texthl = 'DapBreakpoint',
      linehl = 'DapBreakpoint',
      numhl = 'DapBreakpoint'
    })
    vim.fn.sign_define('DapStopped', {
      text = 'â–¶ï¸',
      texthl = 'DapStopped',
      linehl = 'DapStopped',
      numhl = 'DapStopped'
    })

    -- åŸºæœ¬æŒ‰éµæ˜ å°„
    vim.keymap.set("n", "<leader>d", "", { desc = "+Debug" })
    vim.keymap.set("n", "<leader>db", dap.toggle_breakpoint, { desc = "åˆ‡æ›æ–·é»" })
    vim.keymap.set("n", "<leader>dB", function()
      dap.set_breakpoint(vim.fn.input('Breakpoint condition: '))
    end, { desc = "æ¢ä»¶æ–·é»" })
    vim.keymap.set("n", "<leader>dc", dap.continue, { desc = "ç¹¼çºŒ/å•Ÿå‹•" })
    vim.keymap.set("n", "<leader>dC", dap.run_to_cursor, { desc = "åŸ·è¡Œåˆ°æ¸¸æ¨™" })
    vim.keymap.set("n", "<leader>dg", dap.goto_, { desc = "è·³è½‰åˆ°è¡Œ" })
    vim.keymap.set("n", "<leader>di", dap.step_into, { desc = "æ­¥å…¥" })
    vim.keymap.set("n", "<leader>dj", dap.down, { desc = "å‘ä¸‹" })
    vim.keymap.set("n", "<leader>dk", dap.up, { desc = "å‘ä¸Š" })
    vim.keymap.set("n", "<leader>dl", dap.run_last, { desc = "é‡æ–°åŸ·è¡Œ" })
    vim.keymap.set("n", "<leader>do", dap.step_over, { desc = "æ­¥é" })
    vim.keymap.set("n", "<leader>dO", dap.step_out, { desc = "æ­¥å‡º" })
    vim.keymap.set("n", "<leader>dp", dap.pause, { desc = "æš«åœ" })
    vim.keymap.set("n", "<leader>dr", dap.repl.toggle, { desc = "åˆ‡æ› REPL" })
    vim.keymap.set("n", "<leader>ds", dap.session, { desc = "å·¥ä½œéšæ®µ" })
    vim.keymap.set("n", "<leader>dt", dap.terminate, { desc = "çµ‚æ­¢" })
    vim.keymap.set("n", "<leader>dw", function()
      require("dap.ui.widgets").hover()
    end, { desc = "Widgets" })

    -- Mason DAP è¨­ç½®
    require("mason-nvim-dap").setup({
      automatic_setup = true,
      handlers = {},
      ensure_installed = {
        "python",
        "delve", -- Go
        "node2", -- Node.js
        "chrome", -- Chrome/JavaScript
      },
    })

    -- è‡ªå‹•é–‹å•Ÿ/é—œé–‰ UI
    dap.listeners.after.event_initialized["dapui_config"] = function()
      dapui.open()
    end
    dap.listeners.before.event_terminated["dapui_config"] = function()
      dapui.close()
    end
    dap.listeners.before.event_exited["dapui_config"] = function()
      dapui.close()
    end
  end,
}
```

### æ­¥é©Ÿ 2: é™¤éŒ¯ä»‹é¢è¨­ç½®
**ä½ç½®**: `lua/plugins/dap/ui.lua`

```lua
return {
  "rcarriga/nvim-dap-ui",
  dependencies = { "mfussenegger/nvim-dap" },
  config = function()
    local dapui = require("dapui")
    
    dapui.setup({
      icons = { expanded = "", collapsed = "", current_frame = "" },
      mappings = {
        expand = { "<CR>", "<2-LeftMouse>" },
        open = "o",
        remove = "d",
        edit = "e",
        repl = "r",
        toggle = "t",
      },
      expand_lines = vim.fn.has("nvim-0.7") == 1,
      layouts = {
        {
          elements = {
            { id = "scopes", size = 0.25 },
            "breakpoints",
            "stacks",
            "watches",
          },
          size = 40,
          position = "left",
        },
        {
          elements = {
            "repl",
            "console",
          },
          size = 0.25,
          position = "bottom",
        },
      },
      controls = {
        enabled = true,
        element = "repl",
        icons = {
          pause = "",
          play = "",
          step_into = "",
          step_over = "",
          step_out = "",
          step_back = "",
          run_last = "",
          terminate = "",
        },
      },
      floating = {
        max_height = nil,
        max_width = nil,
        border = "single",
        mappings = {
          close = { "q", "<Esc>" },
        },
      },
      windows = { indent = 1 },
      render = {
        max_type_length = nil,
        max_value_lines = 100,
      },
    })

    -- DAP UI æŒ‰éµæ˜ å°„
    vim.keymap.set("n", "<leader>du", dapui.toggle, { desc = "åˆ‡æ›é™¤éŒ¯ UI" })
    vim.keymap.set("n", "<leader>de", dapui.eval, { desc = "è©•ä¼°è¡¨é”å¼" })
    vim.keymap.set("v", "<leader>de", dapui.eval, { desc = "è©•ä¼°é¸å–è¡¨é”å¼" })
  end,
}
```

### æ­¥é©Ÿ 3: è™›æ“¬æ–‡å­—æ”¯æ´
**ä½ç½®**: `lua/plugins/dap/virtual-text.lua`

```lua
return {
  "theHamsta/nvim-dap-virtual-text",
  dependencies = { "mfussenegger/nvim-dap" },
  config = function()
    require("nvim-dap-virtual-text").setup({
      enabled = true,
      enabled_commands = true,
      highlight_changed_variables = true,
      highlight_new_as_changed = false,
      show_stop_reason = true,
      commented = false,
      only_first_definition = true,
      all_references = false,
      filter_references_pattern = '<module',
      virt_text_pos = 'eol',
      all_frames = false,
      virt_lines = false,
      virt_text_win_col = nil
    })
  end,
}
```

## èªè¨€ç‰¹å®šé…ç½®

### Python é™¤éŒ¯è¨­ç½®
```lua
-- åœ¨ dap/init.lua ä¸­æ·»åŠ 
local dap = require("dap")

dap.adapters.python = {
  type = 'executable',
  command = 'python',
  args = { '-m', 'debugpy.adapter' },
}

dap.configurations.python = {
  {
    type = 'python',
    request = 'launch',
    name = "Launch file",
    program = "${file}",
    pythonPath = function()
      return '/usr/bin/python'
    end,
  },
}
```

### JavaScript/Node.js é™¤éŒ¯è¨­ç½®
```lua
dap.adapters.node2 = {
  type = 'executable',
  command = 'node',
  args = {os.getenv('HOME') .. '/dev/microsoft/vscode-node-debug2/out/src/nodeDebug.js'},
}

dap.configurations.javascript = {
  {
    name = 'Launch',
    type = 'node2',
    request = 'launch',
    program = '${file}',
    cwd = vim.fn.getcwd(),
    sourceMaps = true,
    protocol = 'inspector',
    console = 'integratedTerminal',
  },
}
```

### Go é™¤éŒ¯è¨­ç½®
```lua
dap.adapters.delve = {
  type = 'server',
  port = '${port}',
  executable = {
    command = 'dlv',
    args = {'dap', '-l', '127.0.0.1:${port}'},
  }
}

dap.configurations.go = {
  {
    type = "delve",
    name = "Debug",
    request = "launch",
    program = "${file}"
  },
}
```

## æŒ‰éµæ˜ å°„ç¸½çµ

### é™¤éŒ¯æ§åˆ¶
- `<leader>dc` - ç¹¼çºŒ/å•Ÿå‹•é™¤éŒ¯
- `<leader>dt` - çµ‚æ­¢é™¤éŒ¯
- `<leader>dp` - æš«åœåŸ·è¡Œ
- `<leader>dr` - åˆ‡æ› REPL

### æ–·é»ç®¡ç†
- `<leader>db` - åˆ‡æ›æ–·é»
- `<leader>dB` - è¨­ç½®æ¢ä»¶æ–·é»

### æ­¥é€²æ§åˆ¶
- `<leader>di` - æ­¥å…¥ (step into)
- `<leader>do` - æ­¥é (step over)
- `<leader>dO` - æ­¥å‡º (step out)
- `<leader>dC` - åŸ·è¡Œåˆ°æ¸¸æ¨™

### ä»‹é¢æ§åˆ¶
- `<leader>du` - åˆ‡æ›é™¤éŒ¯ UI
- `<leader>de` - è©•ä¼°è¡¨é”å¼

### å°èˆª
- `<leader>dj` / `<leader>dk` - èª¿ç”¨å †ç–Šå‘ä¸‹/å‘ä¸Š

## å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### Q1: é™¤éŒ¯å™¨é€£æ¥å¤±æ•—
**æª¢æŸ¥é …ç›®**:
1. ç¢ºèªé™¤éŒ¯å™¨å·²å®‰è£: `:Mason`
2. æª¢æŸ¥ç¨‹å¼èªè¨€ç‰ˆæœ¬ç›¸å®¹æ€§
3. ç¢ºèªå°ˆæ¡ˆç·¨è­¯è¨­ç½®

### Q2: æ–·é»ç„¡æ•ˆ
**è§£æ±ºæ–¹æ¡ˆ**:
1. ç¢ºèªæª”æ¡ˆå·²å„²å­˜
2. æª¢æŸ¥åŸå§‹ç¢¼æ˜ å°„
3. ç¢ºèªé™¤éŒ¯ç¬¦è™Ÿå­˜åœ¨

### Q3: è®Šæ•¸å€¼ä¸é¡¯ç¤º
**æª¢æŸ¥é …ç›®**:
1. ç¢ºèªè®Šæ•¸åœ¨ç•¶å‰ä½œç”¨åŸŸ
2. æª¢æŸ¥é™¤éŒ¯è³‡è¨Šæ˜¯å¦å®Œæ•´
3. å˜—è©¦æ‰‹å‹•è©•ä¼°è¡¨é”å¼

## æª¢æŸ¥æ¸…å–®
- [ ] DAP æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- [ ] é™¤éŒ¯ UI æ­£å¸¸é¡¯ç¤º
- [ ] æ–·é»åŠŸèƒ½æ­£å¸¸
- [ ] æ­¥é€²æ§åˆ¶æ­£å¸¸
- [ ] è®Šæ•¸æª¢è¦–æ­£å¸¸
- [ ] REPL åŠŸèƒ½æ­£å¸¸
- [ ] å¤šèªè¨€æ”¯æ´æ­£å¸¸