# 2.3 除錯支援系統設置企劃書 - nvim-dap

## 專案概覽
建立完整的除錯系統，支援多種程式語言的斷點除錯、變數檢視、調用堆疊分析和除錯介面整合。

## 目標與預期成果
- ✅ Debug Adapter Protocol (DAP) 支援
- ✅ 斷點管理和條件斷點
- ✅ 變數檢視和值修改
- ✅ 調用堆疊瀏覽
- ✅ 除錯控制台和 REPL
- ✅ 多語言除錯器整合

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 對應程式語言的除錯器 (如 node, python, go 等)
- 編譯後的除錯符號 (debug symbols)

## 核心套件組合
1. **nvim-dap** - DAP 客戶端核心
2. **nvim-dap-ui** - 除錯介面
3. **nvim-dap-virtual-text** - 虛擬文字顯示
4. **mason-nvim-dap.nvim** - 除錯器管理

## 實施步驟

### 步驟 1: DAP 核心設置
**位置**: `lua/plugins/dap/init.lua`

```lua
return {
  "mfussenegger/nvim-dap",
  dependencies = {
    "rcarriga/nvim-dap-ui",
    "theHamsta/nvim-dap-virtual-text",
    "jay-babu/mason-nvim-dap.nvim",
    "williamboman/mason.nvim",
  },
  config = function()
    local dap = require("dap")
    local dapui = require("dapui")

    -- 除錯器圖示設置
    vim.fn.sign_define('DapBreakpoint', {
      text = '🟥',
      texthl = 'DapBreakpoint',
      linehl = 'DapBreakpoint',
      numhl = 'DapBreakpoint'
    })
    vim.fn.sign_define('DapBreakpointCondition', {
      text = '🟡',
      texthl = 'DapBreakpoint',
      linehl = 'DapBreakpoint',
      numhl = 'DapBreakpoint'
    })
    vim.fn.sign_define('DapStopped', {
      text = '▶️',
      texthl = 'DapStopped',
      linehl = 'DapStopped',
      numhl = 'DapStopped'
    })

    -- 基本按鍵映射
    vim.keymap.set("n", "<leader>d", "", { desc = "+Debug" })
    vim.keymap.set("n", "<leader>db", dap.toggle_breakpoint, { desc = "切換斷點" })
    vim.keymap.set("n", "<leader>dB", function()
      dap.set_breakpoint(vim.fn.input('Breakpoint condition: '))
    end, { desc = "條件斷點" })
    vim.keymap.set("n", "<leader>dc", dap.continue, { desc = "繼續/啟動" })
    vim.keymap.set("n", "<leader>dC", dap.run_to_cursor, { desc = "執行到游標" })
    vim.keymap.set("n", "<leader>dg", dap.goto_, { desc = "跳轉到行" })
    vim.keymap.set("n", "<leader>di", dap.step_into, { desc = "步入" })
    vim.keymap.set("n", "<leader>dj", dap.down, { desc = "向下" })
    vim.keymap.set("n", "<leader>dk", dap.up, { desc = "向上" })
    vim.keymap.set("n", "<leader>dl", dap.run_last, { desc = "重新執行" })
    vim.keymap.set("n", "<leader>do", dap.step_over, { desc = "步過" })
    vim.keymap.set("n", "<leader>dO", dap.step_out, { desc = "步出" })
    vim.keymap.set("n", "<leader>dp", dap.pause, { desc = "暫停" })
    vim.keymap.set("n", "<leader>dr", dap.repl.toggle, { desc = "切換 REPL" })
    vim.keymap.set("n", "<leader>ds", dap.session, { desc = "工作階段" })
    vim.keymap.set("n", "<leader>dt", dap.terminate, { desc = "終止" })
    vim.keymap.set("n", "<leader>dw", function()
      require("dap.ui.widgets").hover()
    end, { desc = "Widgets" })

    -- Mason DAP 設置
    require("mason-nvim-dap").setup({
      automatic_setup = true,
      handlers = {},
      ensure_installed = {
        "python",
        "delve", -- Go
        "node2", -- Node.js
        "chrome", -- Chrome/JavaScript
      },
    })

    -- 自動開啟/關閉 UI
    dap.listeners.after.event_initialized["dapui_config"] = function()
      dapui.open()
    end
    dap.listeners.before.event_terminated["dapui_config"] = function()
      dapui.close()
    end
    dap.listeners.before.event_exited["dapui_config"] = function()
      dapui.close()
    end
  end,
}
```

### 步驟 2: 除錯介面設置
**位置**: `lua/plugins/dap/ui.lua`

```lua
return {
  "rcarriga/nvim-dap-ui",
  dependencies = { "mfussenegger/nvim-dap" },
  config = function()
    local dapui = require("dapui")
    
    dapui.setup({
      icons = { expanded = "", collapsed = "", current_frame = "" },
      mappings = {
        expand = { "<CR>", "<2-LeftMouse>" },
        open = "o",
        remove = "d",
        edit = "e",
        repl = "r",
        toggle = "t",
      },
      expand_lines = vim.fn.has("nvim-0.7") == 1,
      layouts = {
        {
          elements = {
            { id = "scopes", size = 0.25 },
            "breakpoints",
            "stacks",
            "watches",
          },
          size = 40,
          position = "left",
        },
        {
          elements = {
            "repl",
            "console",
          },
          size = 0.25,
          position = "bottom",
        },
      },
      controls = {
        enabled = true,
        element = "repl",
        icons = {
          pause = "",
          play = "",
          step_into = "",
          step_over = "",
          step_out = "",
          step_back = "",
          run_last = "",
          terminate = "",
        },
      },
      floating = {
        max_height = nil,
        max_width = nil,
        border = "single",
        mappings = {
          close = { "q", "<Esc>" },
        },
      },
      windows = { indent = 1 },
      render = {
        max_type_length = nil,
        max_value_lines = 100,
      },
    })

    -- DAP UI 按鍵映射
    vim.keymap.set("n", "<leader>du", dapui.toggle, { desc = "切換除錯 UI" })
    vim.keymap.set("n", "<leader>de", dapui.eval, { desc = "評估表達式" })
    vim.keymap.set("v", "<leader>de", dapui.eval, { desc = "評估選取表達式" })
  end,
}
```

### 步驟 3: 虛擬文字支援
**位置**: `lua/plugins/dap/virtual-text.lua`

```lua
return {
  "theHamsta/nvim-dap-virtual-text",
  dependencies = { "mfussenegger/nvim-dap" },
  config = function()
    require("nvim-dap-virtual-text").setup({
      enabled = true,
      enabled_commands = true,
      highlight_changed_variables = true,
      highlight_new_as_changed = false,
      show_stop_reason = true,
      commented = false,
      only_first_definition = true,
      all_references = false,
      filter_references_pattern = '<module',
      virt_text_pos = 'eol',
      all_frames = false,
      virt_lines = false,
      virt_text_win_col = nil
    })
  end,
}
```

## 語言特定配置

### Python 除錯設置
```lua
-- 在 dap/init.lua 中添加
local dap = require("dap")

dap.adapters.python = {
  type = 'executable',
  command = 'python',
  args = { '-m', 'debugpy.adapter' },
}

dap.configurations.python = {
  {
    type = 'python',
    request = 'launch',
    name = "Launch file",
    program = "${file}",
    pythonPath = function()
      return '/usr/bin/python'
    end,
  },
}
```

### JavaScript/Node.js 除錯設置
```lua
dap.adapters.node2 = {
  type = 'executable',
  command = 'node',
  args = {os.getenv('HOME') .. '/dev/microsoft/vscode-node-debug2/out/src/nodeDebug.js'},
}

dap.configurations.javascript = {
  {
    name = 'Launch',
    type = 'node2',
    request = 'launch',
    program = '${file}',
    cwd = vim.fn.getcwd(),
    sourceMaps = true,
    protocol = 'inspector',
    console = 'integratedTerminal',
  },
}
```

### Go 除錯設置
```lua
dap.adapters.delve = {
  type = 'server',
  port = '${port}',
  executable = {
    command = 'dlv',
    args = {'dap', '-l', '127.0.0.1:${port}'},
  }
}

dap.configurations.go = {
  {
    type = "delve",
    name = "Debug",
    request = "launch",
    program = "${file}"
  },
}
```

## 按鍵映射總結

### 除錯控制
- `<leader>dc` - 繼續/啟動除錯
- `<leader>dt` - 終止除錯
- `<leader>dp` - 暫停執行
- `<leader>dr` - 切換 REPL

### 斷點管理
- `<leader>db` - 切換斷點
- `<leader>dB` - 設置條件斷點

### 步進控制
- `<leader>di` - 步入 (step into)
- `<leader>do` - 步過 (step over)
- `<leader>dO` - 步出 (step out)
- `<leader>dC` - 執行到游標

### 介面控制
- `<leader>du` - 切換除錯 UI
- `<leader>de` - 評估表達式

### 導航
- `<leader>dj` / `<leader>dk` - 調用堆疊向下/向上

## 常見問題與解決方案

### Q1: 除錯器連接失敗
**檢查項目**:
1. 確認除錯器已安裝: `:Mason`
2. 檢查程式語言版本相容性
3. 確認專案編譯設置

### Q2: 斷點無效
**解決方案**:
1. 確認檔案已儲存
2. 檢查原始碼映射
3. 確認除錯符號存在

### Q3: 變數值不顯示
**檢查項目**:
1. 確認變數在當前作用域
2. 檢查除錯資訊是否完整
3. 嘗試手動評估表達式

## 檢查清單
- [ ] DAP 核心功能正常
- [ ] 除錯 UI 正常顯示
- [ ] 斷點功能正常
- [ ] 步進控制正常
- [ ] 變數檢視正常
- [ ] REPL 功能正常
- [ ] 多語言支援正常