# 3.2 主題和美化系統設置企劃書

## 專案概覽
建立統一且美觀的視覺主題系統，包括色彩主題選擇、圖示支援、透明背景保持和整體界面美化，提升開發體驗。

## 目標與預期成果
- ✅ 現代化色彩主題整合
- ✅ 統一的圖示系統
- ✅ 透明背景支援
- ✅ 語法高亮優化
- ✅ UI 元素美化
- ✅ 主題切換功能

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成相關 UI 模組 (lualine、nvim-tree 等)
- 支援真彩色的終端
- Nerd Font 字體

## 核心套件組合
1. **catppuccin** - 現代色彩主題
2. **tokyonight.nvim** - 備選主題
3. **nvim-web-devicons** - 檔案圖示
4. **alpha-nvim** - 啟動畫面
5. **indent-blankline.nvim** - 縮排指示器

## 實施步驟

### 步驟 1: 主要色彩主題設置
**位置**: `lua/plugins/colorscheme.lua`

```lua
return {
  -- Catppuccin 主題
  {
    "catppuccin/nvim",
    name = "catppuccin",
    priority = 1000,
    config = function()
      require("catppuccin").setup({
        flavour = "mocha", -- latte, frappe, macchiato, mocha
        background = {
          light = "latte",
          dark = "mocha",
        },
        transparent_background = true, -- 透明背景
        show_end_of_buffer = false,
        term_colors = false,
        dim_inactive = {
          enabled = false,
          shade = "dark",
          percentage = 0.15,
        },
        no_italic = false,
        no_bold = false,
        no_underline = false,
        styles = {
          comments = { "italic" },
          conditionals = { "italic" },
          loops = {},
          functions = {},
          keywords = {},
          strings = {},
          variables = {},
          numbers = {},
          booleans = {},
          properties = {},
          types = {},
          operators = {},
        },
        color_overrides = {},
        custom_highlights = function(colors)
          return {
            -- 自訂高亮
            Comment = { fg = colors.overlay1, style = { "italic" } },
            LineNr = { fg = colors.overlay0 },
            CursorLineNr = { fg = colors.lavender, style = { "bold" } },
            
            -- Telescope 自訂
            TelescopeTitle = { fg = colors.blue, style = { "bold" } },
            TelescopeBorder = { fg = colors.blue },
            TelescopeSelection = { fg = colors.text, bg = colors.surface0, style = { "bold" } },
            
            -- NvimTree 自訂
            NvimTreeFolderIcon = { fg = colors.blue },
            NvimTreeFolderName = { fg = colors.blue },
            NvimTreeOpenedFolderName = { fg = colors.blue, style = { "bold" } },
            
            -- Lualine 整合
            lualine_a_normal = { bg = colors.blue, fg = colors.mantle, style = { "bold" } },
            lualine_a_insert = { bg = colors.green, fg = colors.base, style = { "bold" } },
            lualine_a_visual = { bg = colors.mauve, fg = colors.base, style = { "bold" } },
            lualine_a_command = { bg = colors.peach, fg = colors.base, style = { "bold" } },
          }
        end,
        integrations = {
          cmp = true,
          gitsigns = true,
          nvimtree = true,
          treesitter = true,
          notify = false,
          mini = false,
          telescope = {
            enabled = true,
          },
          lsp_trouble = true,
          which_key = true,
          indent_blankline = {
            enabled = true,
            colored_indent_levels = false,
          },
          native_lsp = {
            enabled = true,
            virtual_text = {
              errors = { "italic" },
              hints = { "italic" },
              warnings = { "italic" },
              information = { "italic" },
            },
            underlines = {
              errors = { "underline" },
              hints = { "underline" },
              warnings = { "underline" },
              information = { "underline" },
            },
            inlay_hints = {
              background = true,
            },
          },
          mason = true,
          dap = {
            enabled = true,
            enable_ui = true,
          },
        },
      })

      -- 設置為預設主題
      vim.cmd.colorscheme "catppuccin"
    end,
  },

  -- Tokyo Night 備選主題
  {
    "folke/tokyonight.nvim",
    lazy = true,
    priority = 1000,
    opts = {
      style = "storm", -- storm, moon, night, day
      light_style = "day",
      transparent = true,
      terminal_colors = true,
      styles = {
        comments = { italic = true },
        keywords = { italic = true },
        functions = {},
        variables = {},
        sidebars = "transparent",
        floats = "transparent",
      },
      sidebars = { "qf", "help", "vista_kind", "terminal", "packer" },
      day_brightness = 0.3,
      hide_inactive_statusline = false,
      dim_inactive = false,
      lualine_bold = false,
      on_colors = function(colors) end,
      on_highlights = function(highlights, colors)
        -- 自訂高亮
        highlights.Comment = { fg = colors.comment, italic = true }
      end,
    },
  },
}
```

### 步驟 2: 圖示系統設置
**位置**: `lua/plugins/icons.lua`

```lua
return {
  "nvim-tree/nvim-web-devicons",
  config = function()
    require("nvim-web-devicons").setup({
      override = {
        zsh = {
          icon = "",
          color = "#428850",
          cterm_color = "65",
          name = "Zsh"
        },
        lua = {
          icon = "",
          color = "#51a0cf",
          cterm_color = "74",
          name = "Lua"
        },
        vim = {
          icon = "",
          color = "#019833",
          cterm_color = "28",
          name = "Vim"
        },
        js = {
          icon = "",
          color = "#cbcb41",
          cterm_color = "185",
          name = "Js"
        },
        ts = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Ts"
        },
        jsx = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Jsx"
        },
        tsx = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Tsx"
        },
        py = {
          icon = "",
          color = "#ffbc03",
          cterm_color = "214",
          name = "Py"
        },
        go = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Go"
        },
        rust = {
          icon = "",
          color = "#dea584",
          cterm_color = "216",
          name = "Rust"
        },
        cpp = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Cpp"
        },
        c = {
          icon = "",
          color = "#599eff",
          cterm_color = "111",
          name = "C"
        },
        java = {
          icon = "",
          color = "#cc3e44",
          cterm_color = "167",
          name = "Java"
        },
        json = {
          icon = "",
          color = "#cbcb41",
          cterm_color = "185",
          name = "Json"
        },
        yaml = {
          icon = "",
          color = "#cbcb41",
          cterm_color = "185",
          name = "Yaml"
        },
        toml = {
          icon = "",
          color = "#cbcb41",
          cterm_color = "185",
          name = "Toml"
        },
        md = {
          icon = "",
          color = "#519aba",
          cterm_color = "67",
          name = "Md"
        },
        html = {
          icon = "",
          color = "#e34c26",
          cterm_color = "196",
          name = "Html"
        },
        css = {
          icon = "",
          color = "#563d7c",
          cterm_color = "62",
          name = "Css"
        },
        scss = {
          icon = "",
          color = "#f55385",
          cterm_color = "204",
          name = "Scss"
        },
      },
      color_icons = true,
      default = true,
      strict = true,
      override_by_filename = {
        [".gitignore"] = {
          icon = "",
          color = "#f1502f",
          name = "Gitignore"
        },
        ["Dockerfile"] = {
          icon = "",
          color = "#458ee6",
          name = "Dockerfile"
        },
        ["docker-compose.yml"] = {
          icon = "",
          color = "#458ee6",
          name = "DockerCompose"
        },
      },
      override_by_extension = {
        ["log"] = {
          icon = "",
          color = "#81e043",
          name = "Log"
        },
      },
    })
  end,
}
```

### 步驟 3: 啟動畫面設置
**位置**: `lua/plugins/alpha.lua`

```lua
return {
  "goolord/alpha-nvim",
  event = "VimEnter",
  dependencies = { "nvim-tree/nvim-web-devicons" },
  config = function()
    local alpha = require("alpha")
    local dashboard = require("alpha.themes.dashboard")

    -- 自訂標題
    dashboard.section.header.val = {
      "                                                     ",
      "  ███╗   ██╗███████╗ ██████╗ ██╗   ██╗██╗███╗   ███╗ ",
      "  ████╗  ██║██╔════╝██╔═══██╗██║   ██║██║████╗ ████║ ",
      "  ██╔██╗ ██║█████╗  ██║   ██║██║   ██║██║██╔████╔██║ ",
      "  ██║╚██╗██║██╔══╝  ██║   ██║╚██╗ ██╔╝██║██║╚██╔╝██║ ",
      "  ██║ ╚████║███████╗╚██████╔╝ ╚████╔╝ ██║██║ ╚═╝ ██║ ",
      "  ╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═══╝  ╚═╝╚═╝     ╚═╝ ",
      "                                                     ",
    }

    -- 自訂按鈕
    dashboard.section.buttons.val = {
      dashboard.button("f", "󰈞  Find file", ":Telescope find_files <CR>"),
      dashboard.button("e", "  New file", ":ene <BAR> startinsert <CR>"),
      dashboard.button("r", "󰄉  Recently used files", ":Telescope oldfiles <CR>"),
      dashboard.button("t", "󰊄  Find text", ":Telescope live_grep <CR>"),
      dashboard.button("c", "  Configuration", ":e $MYVIMRC <CR>"),
      dashboard.button("p", "  Projects", ":Telescope projects <CR>"),
      dashboard.button("q", "󰅚  Quit Neovim", ":qa<CR>"),
    }

    -- 自訂頁腳
    local function footer()
      local total_plugins = #vim.tbl_keys(require("lazy").plugins())
      local datetime = os.date("  %d-%m-%Y   %H:%M:%S")
      local version = vim.version()
      local nvim_version_info = "   v" .. version.major .. "." .. version.minor .. "." .. version.patch

      return datetime .. "   " .. total_plugins .. " plugins" .. nvim_version_info
    end

    dashboard.section.footer.val = footer()

    -- 設置高亮
    dashboard.section.header.opts.hl = "Include"
    dashboard.section.buttons.opts.hl = "Keyword"
    dashboard.section.footer.opts.hl = "Type"

    -- 移除默認的顏色設置
    dashboard.opts.opts.noautocmd = true

    alpha.setup(dashboard.opts)

    -- 自動命令
    vim.api.nvim_create_autocmd("User", {
      pattern = "LazyVimStarted",
      callback = function()
        local stats = require("lazy").stats()
        local ms = (math.floor(stats.startuptime * 100 + 0.5) / 100)
        dashboard.section.footer.val = "⚡ Neovim loaded " .. stats.count .. " plugins in " .. ms .. "ms"
        pcall(vim.cmd.AlphaRedraw)
      end,
    })
  end,
}
```

### 步驟 4: 縮排指示器設置
**位置**: `lua/plugins/indent.lua`

```lua
return {
  "lukas-reineke/indent-blankline.nvim",
  main = "ibl",
  event = { "BufReadPost", "BufNewFile" },
  opts = {
    indent = {
      char = "│",
      tab_char = "│",
    },
    scope = { enabled = false },
    exclude = {
      filetypes = {
        "help",
        "alpha",
        "dashboard",
        "neo-tree",
        "Trouble",
        "trouble",
        "lazy",
        "mason",
        "notify",
        "toggleterm",
        "lazyterm",
      },
    },
  },
  config = function(_, opts)
    require("ibl").setup(opts)

    -- 自訂高亮顏色
    local hooks = require("ibl.hooks")
    hooks.register(hooks.type.HIGHLIGHT_SETUP, function()
      vim.api.nvim_set_hl(0, "IblIndent", { fg = "#3c3836" })
      vim.api.nvim_set_hl(0, "IblScope", { fg = "#665c54" })
    end)
  end,
}
```

### 步驟 5: 主題切換功能
**位置**: `lua/plugins/theme-switcher.lua`

```lua
return {
  "zaldih/themery.nvim",
  cmd = "Themery",
  config = function()
    require("themery").setup({
      themes = {
        "catppuccin-latte",
        "catppuccin-frappe", 
        "catppuccin-macchiato",
        "catppuccin-mocha",
        "tokyonight",
        "tokyonight-night",
        "tokyonight-storm",
        "tokyonight-day",
        "default",
      },
      livePreview = true,
    })

    -- 主題切換按鍵
    vim.keymap.set("n", "<leader>th", ":Themery<CR>", { desc = "主題選擇器" })
  end,
}
```

## 透明背景設置

### 全局透明度配置
**位置**: `lua/core/options.lua` (添加)

```lua
-- 透明背景設置
vim.api.nvim_create_autocmd("ColorScheme", {
  pattern = "*",
  callback = function()
    -- 保持透明背景
    vim.api.nvim_set_hl(0, "Normal", { bg = "NONE", ctermbg = "NONE" })
    vim.api.nvim_set_hl(0, "NormalFloat", { bg = "NONE", ctermbg = "NONE" })
    vim.api.nvim_set_hl(0, "SignColumn", { bg = "NONE", ctermbg = "NONE" })
    vim.api.nvim_set_hl(0, "EndOfBuffer", { bg = "NONE", ctermbg = "NONE" })
    
    -- NvimTree 透明
    vim.api.nvim_set_hl(0, "NvimTreeNormal", { bg = "NONE" })
    vim.api.nvim_set_hl(0, "NvimTreeEndOfBuffer", { bg = "NONE" })
    
    -- Telescope 透明
    vim.api.nvim_set_hl(0, "TelescopeNormal", { bg = "NONE" })
    vim.api.nvim_set_hl(0, "TelescopeBorder", { bg = "NONE" })
  end,
})

-- 切換透明度功能
local transparency_enabled = true
local function toggle_transparency()
  if transparency_enabled then
    vim.cmd("highlight Normal guibg=#1e1e2e")
    vim.cmd("highlight NormalFloat guibg=#1e1e2e")
    transparency_enabled = false
    print("透明度已禁用")
  else
    vim.cmd("highlight Normal guibg=NONE")
    vim.cmd("highlight NormalFloat guibg=NONE")
    transparency_enabled = true
    print("透明度已啟用")
  end
end

vim.keymap.set("n", "<leader>tt", toggle_transparency, { desc = "切換透明度" })
```

## 驗證與測試

### 主題測試
1. **基本主題測試**:
   ```vim
   :colorscheme catppuccin
   :colorscheme tokyonight
   ```

2. **透明背景測試**:
   - 確認終端透明效果
   - 測試各種 UI 元素的透明度

3. **圖示測試**:
   - 開啟不同檔案類型檢查圖示
   - 測試 nvim-tree 圖示顯示

### 整合測試
```lua
-- 測試所有 UI 元素的主題一致性
:Telescope find_files
:NvimTreeToggle
:Alpha
```

## 自定義主題配色

### 自訂 Catppuccin 配色
```lua
color_overrides = {
  mocha = {
    base = "#000000",
    mantle = "#000000",
    crust = "#000000",
  },
},
```

### 創建自訂主題
```lua
-- 在 ~/.config/nvim/colors/ 目錄下創建 mytheme.vim
local M = {}

M.setup = function()
  vim.cmd("highlight clear")
  if vim.fn.exists("syntax_on") then
    vim.cmd("syntax reset")
  end
  
  vim.g.colors_name = "mytheme"
  
  -- 定義顏色
  local colors = {
    bg = "#1a1b26",
    fg = "#c0caf5",
    -- 更多顏色定義...
  }
  
  -- 設置高亮
  vim.api.nvim_set_hl(0, "Normal", { fg = colors.fg, bg = colors.bg })
  -- 更多高亮設置...
end

return M
```

## 按鍵映射總結

### 主題相關
- `<leader>th` - 開啟主題選擇器
- `<leader>tt` - 切換透明度

### 快速主題切換
```lua
vim.keymap.set("n", "<leader>t1", ":colorscheme catppuccin-mocha<CR>", { desc = "Catppuccin Mocha" })
vim.keymap.set("n", "<leader>t2", ":colorscheme tokyonight-storm<CR>", { desc = "Tokyo Night Storm" })
vim.keymap.set("n", "<leader>t3", ":colorscheme catppuccin-latte<CR>", { desc = "Catppuccin Latte" })
```

## 常見問題與解決方案

### Q1: 主題不生效
**檢查項目**:
1. 確認終端支援真彩色: `:set termguicolors?`
2. 檢查主題是否正確安裝
3. 確認沒有衝突的配色設置

### Q2: 透明背景失效
**解決方案**:
1. 確認終端支援透明度
2. 檢查終端配置
3. 確認 autocmd 設置正確

### Q3: 圖示顯示異常
**檢查項目**:
1. 確認已安裝 Nerd Font
2. 檢查終端字體設置
3. 測試字體支援: `echo -e "\ue0b0 \u00b1 \ue0a0 \u27a6 \u2718 \u26a1 \u2699"`

### Q4: 主題載入慢
**優化方案**:
1. 設置 `priority = 1000`
2. 使用 `lazy = false` 立即載入
3. 減少不必要的自訂高亮

## 檢查清單
- [ ] 主色彩主題正常載入
- [ ] 備選主題可正常切換
- [ ] 圖示系統正常顯示
- [ ] 啟動畫面正常顯示
- [ ] 縮排指示器正常
- [ ] 透明背景功能正常
- [ ] 主題切換器功能正常
- [ ] 所有 UI 元素主題統一

## 與其他模組的集成
- **狀態列**: Lualine 主題自動適配
- **檔案管理**: nvim-tree 圖示和主題整合
- **模糊搜尋**: Telescope 主題自訂
- **LSP 系統**: 診斷高亮主題整合
- **Git 整合**: Git 狀態顏色配置