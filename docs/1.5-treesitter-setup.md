# 1.5 語法高亮系統設置企劃書 - nvim-treesitter

## 專案概覽
建立現代化的語法高亮和代碼解析系統，使用 Tree-sitter 技術提供精確的語法高亮、智能選取、代碼折疊和縮排檢測功能。

## 目標與預期成果
- ✅ 精確的語法高亮和著色
- ✅ 智能文字物件選取
- ✅ 語法感知的代碼折疊
- ✅ 自動縮排檢測和調整
- ✅ 語法導航和移動
- ✅ 多語言支援和擴展

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- Neovim 0.8+ 版本 (支援 Tree-sitter)
- C 編譯器 (gcc/clang) - 用於編譯 parser
- Git (用於下載 parser)

## 核心套件組合
1. **nvim-treesitter** - Tree-sitter 核心整合
2. **nvim-treesitter-textobjects** - 語法感知的文字物件
3. **nvim-treesitter-context** - 顯示當前上下文
4. **nvim-ts-rainbow** - 彩虹括號 (可選)
5. **nvim-ts-autotag** - HTML/XML 標籤自動配對

## 實施步驟

### 步驟 1: 核心 Treesitter 設置
**位置**: `lua/plugins/treesitter.lua`

```lua
return {
  "nvim-treesitter/nvim-treesitter",
  build = ":TSUpdate",
  event = { "BufReadPost", "BufNewFile" },
  dependencies = {
    "nvim-treesitter/nvim-treesitter-textobjects",
    "nvim-treesitter/nvim-treesitter-context",
    "windwp/nvim-ts-autotag",
  },
  config = function()
    require("nvim-treesitter.configs").setup({
      -- 自動安裝的 parser 列表
      ensure_installed = {
        "bash",
        "c",
        "cpp",
        "css",
        "dockerfile",
        "go",
        "html",
        "javascript",
        "json",
        "lua",
        "markdown",
        "markdown_inline",
        "python",
        "query",
        "regex",
        "rust",
        "typescript",
        "vim",
        "vimdoc",
        "yaml",
      },

      -- 自動安裝缺失的 parser
      auto_install = true,

      -- 語法高亮設置
      highlight = {
        enable = true,
        -- 設定為 false 將禁用整個擴展
        disable = function(lang, buf)
          local max_filesize = 100 * 1024 -- 100 KB
          local ok, stats = pcall(vim.loop.fs_stat, vim.api.nvim_buf_get_name(buf))
          if ok and stats and stats.size > max_filesize then
            return true
          end
        end,
        -- 某些語言使用 vim 的正則表達式高亮
        additional_vim_regex_highlighting = false,
      },

      -- 縮排設置
      indent = {
        enable = true,
        disable = { "yaml", "python" }, -- 某些語言縮排問題較多
      },

      -- 增量選取
      incremental_selection = {
        enable = true,
        keymaps = {
          init_selection = "<C-space>",
          node_incremental = "<C-space>",
          scope_incremental = "<C-s>",
          node_decremental = "<M-space>",
        },
      },

      -- 文字物件
      textobjects = {
        select = {
          enable = true,
          lookahead = true, -- 自動跳轉到文字物件
          keymaps = {
            -- 你可以使用自己定義的文字物件
            ["af"] = "@function.outer",
            ["if"] = "@function.inner",
            ["ac"] = "@class.outer",
            ["ic"] = "@class.inner",
            ["al"] = "@loop.outer",
            ["il"] = "@loop.inner",
            ["ab"] = "@block.outer",
            ["ib"] = "@block.inner",
            ["aa"] = "@parameter.outer",
            ["ia"] = "@parameter.inner",
            ["aj"] = "@conditional.outer",
            ["ij"] = "@conditional.inner",
          },
          selection_modes = {
            ['@parameter.outer'] = 'v', -- charwise
            ['@function.outer'] = 'V', -- linewise
            ['@class.outer'] = '<c-v>', -- blockwise
          },
          include_surrounding_whitespace = true,
        },
        
        -- 移動
        move = {
          enable = true,
          set_jumps = true, -- 是否設置跳轉點
          goto_next_start = {
            ["]m"] = "@function.outer",
            ["]]"] = "@class.outer",
            ["]l"] = "@loop.outer",
            ["]j"] = "@conditional.outer",
          },
          goto_next_end = {
            ["]M"] = "@function.outer",
            ["]["] = "@class.outer",
            ["]L"] = "@loop.outer",
            ["]J"] = "@conditional.outer",
          },
          goto_previous_start = {
            ["[m"] = "@function.outer",
            ["[["] = "@class.outer",
            ["[l"] = "@loop.outer",
            ["[j"] = "@conditional.outer",
          },
          goto_previous_end = {
            ["[M"] = "@function.outer",
            ["[]"] = "@class.outer",
            ["[L"] = "@loop.outer",
            ["[J"] = "@conditional.outer",
          },
        },

        -- 交換
        swap = {
          enable = true,
          swap_next = {
            ["<leader>a"] = "@parameter.inner",
          },
          swap_previous = {
            ["<leader>A"] = "@parameter.inner",
          },
        },

        -- LSP 互操作
        lsp_interop = {
          enable = true,
          border = 'none',
          floating_preview_opts = {},
          peek_definition_code = {
            ["<leader>df"] = "@function.outer",
            ["<leader>dF"] = "@class.outer",
          },
        },
      },

      -- 匹配
      matchup = {
        enable = true, -- 可選: 需要 vim-matchup 套件
      },
    })

    -- 設置代碼折疊
    vim.opt.foldmethod = "expr"
    vim.opt.foldexpr = "nvim_treesitter#foldexpr()"
    vim.opt.foldenable = false -- 預設不折疊

    -- 手動重新載入高亮 (用於除錯)
    vim.keymap.set("n", "<leader>R", ":write | edit | TSBufEnable highlight<CR>", 
      { silent = true, desc = "重新載入 Treesitter 高亮" })
  end,
}
```

### 步驟 2: 上下文顯示和增強功能
**位置**: `lua/plugins/treesitter-context.lua`

```lua
return {
  "nvim-treesitter/nvim-treesitter-context",
  dependencies = "nvim-treesitter/nvim-treesitter",
  opts = {
    enable = true,
    max_lines = 0, -- 沒有限制
    min_window_height = 0, -- 最小視窗高度
    line_numbers = true,
    multiline_threshold = 20, -- 最大行數
    trim_scope = 'outer', -- 修剪長行
    mode = 'cursor', -- 行模式: 'cursor' (預設), 'topline'
    separator = nil, -- 分隔符
    zindex = 20, -- 浮動視窗的 z-index
    on_attach = nil, -- (fun(buf: integer): boolean) 返回 false 將禁用附加
  },
  config = function(_, opts)
    require("treesitter-context").setup(opts)
    
    -- 按鍵映射
    vim.keymap.set("n", "[c", function()
      require("treesitter-context").go_to_context()
    end, { silent = true, desc = "跳轉到上下文" })
    
    -- 切換上下文顯示
    vim.keymap.set("n", "<leader>tc", ":TSContextToggle<CR>", 
      { silent = true, desc = "切換 Treesitter 上下文" })
  end,
}
```

### 步驟 3: 自動標籤配對和特殊功能
**位置**: `lua/plugins/treesitter-autotag.lua`

```lua
return {
  "windwp/nvim-ts-autotag",
  dependencies = "nvim-treesitter/nvim-treesitter",
  event = { "BufReadPost", "BufNewFile" },
  opts = {
    opts = {
      -- 預設設置
      enable_close = true, -- 自動關閉標籤
      enable_rename = true, -- 自動重新命名配對標籤
      enable_close_on_slash = false -- 在 `/` 後自動關閉
    },
    -- 每種語言的特殊設置
    per_filetype = {
      ["html"] = {
        enable_close = false
      }
    }
  },
  config = function(_, opts)
    require("nvim-ts-autotag").setup(opts)
  end,
}
```

### 步驟 4: 彩虹括號 (可選)
**位置**: `lua/plugins/treesitter-rainbow.lua`

```lua
return {
  "HiPhish/nvim-ts-rainbow2",
  dependencies = "nvim-treesitter/nvim-treesitter",
  event = { "BufReadPost", "BufNewFile" },
  config = function()
    require("nvim-treesitter.configs").setup({
      rainbow = {
        enable = true,
        -- list of languages you want to disable the plugin for
        disable = { "jsx", "cpp" },
        -- Which query to use for finding delimiters
        query = 'rainbow-parens',
        -- Highlight the entire buffer all at once
        strategy = require('ts-rainbow').strategy.global,
        -- Do not enable for files with more than n lines
        max_file_lines = 3000
      }
    })
  end,
}
```

### 步驟 5: 語法感知的代碼操作
**位置**: `lua/plugins/treesitter-operations.lua`

```lua
return {
  "nvim-treesitter/nvim-treesitter",
  dependencies = {
    "nvim-treesitter/nvim-treesitter-textobjects",
  },
  config = function()
    -- 自定義函數：選取當前函數
    local function select_current_function()
      local ts_utils = require("nvim-treesitter.ts_utils")
      local node = ts_utils.get_node_at_cursor()
      
      while node do
        if node:type() == "function_definition" or 
           node:type() == "function_declaration" or
           node:type() == "method_definition" then
          ts_utils.select_node(node)
          return
        end
        node = node:parent()
      end
      print("No function found at cursor")
    end

    -- 自定義函數：選取當前類別
    local function select_current_class()
      local ts_utils = require("nvim-treesitter.ts_utils")
      local node = ts_utils.get_node_at_cursor()
      
      while node do
        if node:type() == "class_definition" or 
           node:type() == "class_declaration" then
          ts_utils.select_node(node)
          return
        end
        node = node:parent()
      end
      print("No class found at cursor")
    end

    -- 自定義函數：跳轉到下一個錯誤節點
    local function goto_next_error()
      local ts_utils = require("nvim-treesitter.ts_utils")
      local current_node = ts_utils.get_node_at_cursor()
      local root = ts_utils.get_root_for_node(current_node)
      
      local function has_error(node)
        return node:has_error() or node:type() == "ERROR"
      end
      
      local function find_next_error(node, current_row, current_col)
        for child in node:iter_children() do
          local start_row, start_col = child:start()
          if (start_row > current_row or (start_row == current_row and start_col > current_col)) then
            if has_error(child) then
              return child
            end
            local result = find_next_error(child, current_row, current_col)
            if result then return result end
          end
        end
        return nil
      end
      
      local current_row, current_col = unpack(vim.api.nvim_win_get_cursor(0))
      current_row = current_row - 1 -- API is 0-based
      
      local error_node = find_next_error(root, current_row, current_col)
      if error_node then
        local start_row, start_col = error_node:start()
        vim.api.nvim_win_set_cursor(0, { start_row + 1, start_col })
      else
        print("No syntax errors found")
      end
    end

    -- 註冊按鍵映射
    vim.keymap.set("n", "<leader>sf", select_current_function, 
      { desc = "選取當前函數" })
    vim.keymap.set("n", "<leader>sc", select_current_class, 
      { desc = "選取當前類別" })
    vim.keymap.set("n", "]e", goto_next_error, 
      { desc = "跳轉到下一個語法錯誤" })
  end,
}
```

## 驗證與測試

### 基本功能測試
1. **語法高亮測試**:
   ```vim
   :TSInstall lua
   :TSBufEnable highlight
   # 檢查是否有正確的語法高亮
   ```

2. **文字物件測試**:
   ```lua
   function test()
     if true then
       print("test")
     end
   end
   ```
   - 將游標置於 `print` 上，按 `af` 應該選取整個函數
   - 按 `if` 應該選取函數內部

3. **增量選取測試**:
   - 按 `<C-space>` 開始選取
   - 繼續按 `<C-space>` 擴大選取範圍

### 高級功能測試
```javascript
// 測試 JavaScript 支援
function example(param1, param2) {
  if (condition) {
    for (let i = 0; i < 10; i++) {
      console.log(i);
    }
  }
}
```

## Treesitter 指令總覽

### 基本指令
```vim
:TSInstall <language>          " 安裝語言 parser
:TSUninstall <language>        " 移除語言 parser
:TSUpdate                      " 更新所有 parser
:TSUpdateSync                  " 同步更新所有 parser
```

### 狀態檢查
```vim
:TSInstallInfo                 " 顯示安裝資訊
:TSModuleInfo                  " 顯示模組資訊
:checkhealth nvim-treesitter   " 健康檢查
```

### 功能切換
```vim
:TSBufEnable highlight         " 啟用當前緩衝區高亮
:TSBufDisable highlight        " 禁用當前緩衝區高亮
:TSEnable highlight            " 全域啟用高亮
:TSDisable highlight           " 全域禁用高亮
```

## 按鍵映射總結

### 文字物件選取
- `af` / `if` - 函數 (外部/內部)
- `ac` / `ic` - 類別 (外部/內部)
- `al` / `il` - 迴圈 (外部/內部)
- `ab` / `ib` - 區塊 (外部/內部)
- `aa` / `ia` - 參數 (外部/內部)
- `aj` / `ij` - 條件 (外部/內部)

### 導航移動
- `]m` / `[m` - 下一個/上一個函數開始
- `]M` / `[M` - 下一個/上一個函數結尾
- `]]` / `[[` - 下一個/上一個類別
- `]l` / `[l` - 下一個/上一個迴圈
- `]j` / `[j` - 下一個/上一個條件

### 增量選取
- `<C-space>` - 開始/擴大選取
- `<C-s>` - 擴大到作用域
- `<M-space>` - 縮小選取

### 交換和操作
- `<leader>a` - 交換下一個參數
- `<leader>A` - 交換上一個參數

### 上下文和診斷
- `[c` - 跳轉到上下文
- `<leader>tc` - 切換上下文顯示
- `]e` - 跳轉到下一個語法錯誤

## 常見問題與解決方案

### Q1: Parser 安裝失敗
**檢查項目**:
1. 確認有 C 編譯器: `gcc --version` 或 `clang --version`
2. 檢查網路連線
3. 手動安裝: `:TSInstall! <language>`

### Q2: 語法高亮不正確
**解決方案**:
```vim
:TSUpdateSync
:write | edit | TSBufEnable highlight
```

### Q3: 文字物件不工作
**檢查項目**:
1. 確認 textobjects 模組已啟用
2. 檢查檔案類型: `:set filetype?`
3. 檢查 query: `:TSEditQuery textobjects`

### Q4: 效能問題
**優化方案**:
```lua
highlight = {
  enable = true,
  disable = function(lang, buf)
    local max_filesize = 100 * 1024 -- 100 KB
    local ok, stats = pcall(vim.loop.fs_stat, vim.api.nvim_buf_get_name(buf))
    if ok and stats and stats.size > max_filesize then
      return true
    end
  end,
},
```

### Q5: 特定語言支援問題
**解決方案**:
1. 檢查支援列表: `:TSInstallInfo`
2. 查看可用 parser: [GitHub 列表](https://github.com/nvim-treesitter/nvim-treesitter#supported-languages)
3. 自定義 query: `:TSEditQuery <language> <query_type>`

## 進階配置

### 自定義高亮群組
```lua
-- 在 colorscheme 載入後執行
vim.api.nvim_create_autocmd("ColorScheme", {
  callback = function()
    vim.api.nvim_set_hl(0, "@function", { fg = "#61AFEF", bold = true })
    vim.api.nvim_set_hl(0, "@keyword", { fg = "#C678DD", italic = true })
    vim.api.nvim_set_hl(0, "@string", { fg = "#98C379" })
  end,
})
```

### 語言特定設置
```lua
-- 為不同語言設置不同行為
vim.api.nvim_create_autocmd("FileType", {
  pattern = "python",
  callback = function()
    vim.opt_local.foldmethod = "expr"
    vim.opt_local.foldexpr = "nvim_treesitter#foldexpr()"
  end,
})
```

### 自定義 Query
```lua
-- 添加自定義 query
local query = [[
  (function_definition
    name: (identifier) @function.name
    body: (block) @function.body)
]]

vim.treesitter.query.add_directive("custom-function!", function(match, pattern, source, predicate)
  -- 自定義邏輯
end)
```

## 效能優化建議

1. **大檔案處理**: 設置檔案大小限制
2. **選擇性啟用**: 只為需要的語言啟用功能
3. **延遲載入**: 使用 `event` 觸發載入
4. **記憶體管理**: 定期檢查和清理 parser cache

## 檢查清單
- [ ] Treesitter 核心功能正常
- [ ] 常用語言 parser 已安裝
- [ ] 語法高亮功能正常
- [ ] 文字物件選取正常
- [ ] 增量選取功能正常
- [ ] 代碼折疊功能正常
- [ ] 上下文顯示正常
- [ ] 自動標籤配對正常 (HTML/XML)
- [ ] 按鍵映射設置完成
- [ ] 效能表現良好

## 與其他模組的集成
- **LSP 系統**: 提供語法感知的補全和導航
- **模糊搜尋**: 改善 Telescope 的符號搜尋精度
- **自動完成**: 提供更精確的上下文感知補全
- **Git 整合**: 語法感知的 diff 顯示