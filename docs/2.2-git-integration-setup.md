# 2.2 Git 整合系統設置企劃書 - gitsigns + fugitive

## 專案概覽
建立完整的 Git 版本控制整合系統，提供行內 Git 狀態顯示、Git 命令整合、差異比較和合併工具，實現無縫的版本控制工作流程。

## 目標與預期成果
- ✅ 行內 Git 狀態和變更顯示
- ✅ Git 命令整合和快捷操作
- ✅ 可視化差異比較和瀏覽
- ✅ 分支管理和切換
- ✅ 提交歷史瀏覽和搜尋
- ✅ 衝突解決和合併工具

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成 1.4 模糊搜尋設置 (telescope.nvim，可選)
- Git 2.0+ 版本
- 在 Git 倉庫中工作

## 核心套件組合
1. **gitsigns.nvim** - 行內 Git 狀態顯示
2. **vim-fugitive** - Git 命令整合
3. **diffview.nvim** - 差異檢視和歷史瀏覽
4. **neogit** - Git 操作介面 (可選)

## 實施步驟

### 步驟 1: Git 狀態顯示 - gitsigns
**位置**: `lua/plugins/gitsigns.lua`

```lua
return {
  "lewis6991/gitsigns.nvim",
  event = { "BufReadPre", "BufNewFile" },
  opts = {
    signs = {
      add          = { text = '│' },
      change       = { text = '│' },
      delete       = { text = '_' },
      topdelete    = { text = '‾' },
      changedelete = { text = '~' },
      untracked    = { text = '┆' },
    },
    signcolumn = true,  -- 切換符號欄
    numhl      = false, -- 切換行號高亮
    linehl     = false, -- 切換行高亮
    word_diff  = false, -- 切換單詞差異
    watch_gitdir = {
      follow_files = true
    },
    attach_to_untracked = false,
    current_line_blame = false, -- 切換當前行 blame
    current_line_blame_opts = {
      virt_text = true,
      virt_text_pos = 'eol', -- 'eol' | 'overlay' | 'right_align'
      delay = 1000,
      ignore_whitespace = false,
      virt_text_priority = 100,
    },
    current_line_blame_formatter = '<author>, <author_time:%Y-%m-%d> - <summary>',
    sign_priority = 6,
    update_debounce = 100,
    status_formatter = nil, -- 使用預設
    max_file_length = 40000, -- 禁用超過此行數的檔案
    preview_config = {
      -- 懸浮視窗的選項
      border = 'single',
      style = 'minimal',
      relative = 'cursor',
      row = 0,
      col = 1
    },
    yadm = {
      enable = false
    },
  },
  config = function(_, opts)
    require("gitsigns").setup(opts)

    -- 按鍵映射
    local gs = require("gitsigns")

    -- 導航
    vim.keymap.set('n', ']c', function()
      if vim.wo.diff then return ']c' end
      vim.schedule(function() gs.next_hunk() end)
      return '<Ignore>'
    end, { expr = true, desc = "下一個 Git hunk" })

    vim.keymap.set('n', '[c', function()
      if vim.wo.diff then return '[c' end
      vim.schedule(function() gs.prev_hunk() end)
      return '<Ignore>'
    end, { expr = true, desc = "上一個 Git hunk" })

    -- 動作
    vim.keymap.set('n', '<leader>hs', gs.stage_hunk, { desc = "暫存 hunk" })
    vim.keymap.set('n', '<leader>hr', gs.reset_hunk, { desc = "重置 hunk" })
    vim.keymap.set('v', '<leader>hs', function() gs.stage_hunk {vim.fn.line('.'), vim.fn.line('v')} end, { desc = "暫存所選 hunk" })
    vim.keymap.set('v', '<leader>hr', function() gs.reset_hunk {vim.fn.line('.'), vim.fn.line('v')} end, { desc = "重置所選 hunk" })
    vim.keymap.set('n', '<leader>hS', gs.stage_buffer, { desc = "暫存緩衝區" })
    vim.keymap.set('n', '<leader>hu', gs.undo_stage_hunk, { desc = "撤銷暫存 hunk" })
    vim.keymap.set('n', '<leader>hR', gs.reset_buffer, { desc = "重置緩衝區" })
    vim.keymap.set('n', '<leader>hp', gs.preview_hunk, { desc = "預覽 hunk" })
    vim.keymap.set('n', '<leader>hb', function() gs.blame_line{full=true} end, { desc = "責任歸屬當前行" })
    vim.keymap.set('n', '<leader>tb', gs.toggle_current_line_blame, { desc = "切換當前行 blame" })
    vim.keymap.set('n', '<leader>hd', gs.diffthis, { desc = "Diff 當前檔案" })
    vim.keymap.set('n', '<leader>hD', function() gs.diffthis('~') end, { desc = "Diff 與 HEAD" })
    vim.keymap.set('n', '<leader>td', gs.toggle_deleted, { desc = "切換顯示已刪除" })

    -- 文字物件
    vim.keymap.set({'o', 'x'}, 'ih', ':<C-U>Gitsigns select_hunk<CR>', { desc = "選取 Git hunk" })
  end
}
```

### 步驟 2: Git 命令整合 - fugitive
**位置**: `lua/plugins/fugitive.lua`

```lua
return {
  "tpope/vim-fugitive",
  event = "VeryLazy",
  config = function()
    -- Git 相關按鍵映射
    vim.keymap.set("n", "<leader>g", "", { desc = "+Git" })
    
    -- 基本 Git 操作
    vim.keymap.set("n", "<leader>gs", ":Git<CR>", { desc = "Git 狀態" })
    vim.keymap.set("n", "<leader>gS", ":Git add %<CR>", { desc = "暫存當前檔案" })
    vim.keymap.set("n", "<leader>ga", ":Git add .<CR>", { desc = "暫存所有檔案" })
    vim.keymap.set("n", "<leader>gc", ":Git commit<CR>", { desc = "Git 提交" })
    vim.keymap.set("n", "<leader>gC", ":Git commit --amend<CR>", { desc = "修改提交" })
    vim.keymap.set("n", "<leader>gp", ":Git push<CR>", { desc = "Git 推送" })
    vim.keymap.set("n", "<leader>gP", ":Git pull<CR>", { desc = "Git 拉取" })
    vim.keymap.set("n", "<leader>gf", ":Git fetch<CR>", { desc = "Git 獲取" })

    -- 分支操作
    vim.keymap.set("n", "<leader>gb", ":Git branch<CR>", { desc = "分支列表" })
    vim.keymap.set("n", "<leader>gB", ":Git checkout -b ", { desc = "新建分支" })
    vim.keymap.set("n", "<leader>go", ":Git checkout ", { desc = "切換分支" })

    -- 日誌和歷史
    vim.keymap.set("n", "<leader>gl", ":Git log<CR>", { desc = "Git 日誌" })
    vim.keymap.set("n", "<leader>gL", ":Git log --oneline<CR>", { desc = "Git 日誌 (簡潔)" })
    vim.keymap.set("n", "<leader>gh", ":0Gclog<CR>", { desc = "當前檔案歷史" })

    -- 差異比較
    vim.keymap.set("n", "<leader>gd", ":Gdiffsplit<CR>", { desc = "Git diff" })
    vim.keymap.set("n", "<leader>gD", ":Gdiffsplit HEAD<CR>", { desc = "與 HEAD diff" })

    -- 責任歸屬
    vim.keymap.set("n", "<leader>gB", ":Git blame<CR>", { desc = "Git blame" })

    -- 衝突解決
    vim.keymap.set("n", "<leader>gm", ":Git mergetool<CR>", { desc = "合併工具" })

    -- 在 fugitive buffer 中的特殊按鍵映射
    vim.api.nvim_create_autocmd("FileType", {
      pattern = "fugitive",
      callback = function()
        local bufnr = vim.api.nvim_get_current_buf()
        local opts = { buffer = bufnr, silent = true }

        -- 在 Git status 中快速操作
        vim.keymap.set("n", "dp", ":diffput<CR>", opts)
        vim.keymap.set("n", "do", ":diffget<CR>", opts)
        
        -- 快速提交
        vim.keymap.set("n", "cc", ":Git commit<CR>", opts)
        vim.keymap.set("n", "ca", ":Git commit --amend<CR>", opts)
        
        -- 快速推送/拉取
        vim.keymap.set("n", "gp", ":Git push<CR>", opts)
        vim.keymap.set("n", "gf", ":Git pull<CR>", opts)
      end,
    })

    -- 自動命令增強
    vim.api.nvim_create_autocmd("User", {
      pattern = "FugitiveChanged",
      callback = function()
        -- 當 Git 狀態改變時更新 gitsigns
        if require("gitsigns") then
          require("gitsigns").refresh()
        end
      end,
    })
  end,
}
```

### 步驟 3: 差異檢視和歷史瀏覽 - diffview
**位置**: `lua/plugins/diffview.lua`

```lua
return {
  "sindrets/diffview.nvim",
  dependencies = "nvim-lua/plenary.nvim",
  cmd = { "DiffviewOpen", "DiffviewClose", "DiffviewToggleFiles", "DiffviewFocusFiles" },
  config = function()
    require("diffview").setup({
      diff_binaries = false,    -- 顯示二進位檔案的 diff
      enhanced_diff_hl = false, -- 增強的 diff 高亮
      git_cmd = { "git" },      -- Git 命令
      use_icons = true,         -- 使用檔案圖示
      show_help_hints = true,   -- 顯示幫助提示
      watch_index = true,       -- 監視 Git index 變化
      icons = {                 -- 自定義圖示
        folder_closed = "",
        folder_open = "",
      },
      signs = {
        fold_closed = "",
        fold_open = "",
        done = "✓",
      },
      view = {
        -- 配置不同檢視的預設佈局和行為
        default = {
          -- 可用佈局: 'diff1_plain'
          --           'diff2_horizontal'
          --           'diff2_vertical'
          --           'diff3_horizontal'
          --           'diff3_vertical'
          --           'diff3_mixed'
          --           'diff4_mixed'
          layout = "diff2_horizontal",
          winbar_info = false,          -- 在 winbar 中顯示檔案資訊
        },
        merge_tool = {
          -- 合併衝突時的配置
          layout = "diff3_horizontal",
          disable_diagnostics = true,   -- 在合併檢視中禁用診斷
          winbar_info = true,
        },
        file_history = {
          -- 檔案歷史檢視的配置
          layout = "diff2_horizontal",
          winbar_info = false,
        },
      },
      file_panel = {
        listing_style = "tree",             -- "list" | "tree"
        tree_options = {                    -- 只在 listing_style == "tree" 時有效
          flatten_dirs = true,              -- 壓縮只有一個子目錄的目錄
          folder_statuses = "only_folded",  -- "never" | "only_folded" | "always"
        },
        win_config = {                      -- 檔案面板視窗配置
          position = "left",                -- "left" | "right" | "top" | "bottom"
          width = 35,                       -- 只在 position == "left" | "right" 時有效
          height = 10,                      -- 只在 position == "top" | "bottom" 時有效
          win_opts = {}                     -- 傳遞給 nvim_open_win() 的選項
        },
      },
      file_history_panel = {
        log_options = {   -- Git log 選項
          git = {
            single_file = {
              diff_merges = "combined",
            },
            multi_file = {
              diff_merges = "first-parent",
            },
          },
        },
        win_config = {    -- 歷史面板視窗配置
          position = "bottom",
          height = 16,
          win_opts = {}
        },
      },
      commit_log_panel = {
        win_config = {   -- 提交日誌面板視窗配置
          win_opts = {},
        }
      },
      default_args = {    -- 傳遞給 Git 的預設參數
        DiffviewOpen = {},
        DiffviewFileHistory = {},
      },
      hooks = {},         -- 見 ':h diffview-config-hooks'
      keymaps = {
        disable_defaults = false,    -- 禁用預設按鍵映射
        view = {
          -- diffview 檢視中的按鍵映射
          ["<tab>"]      = actions.select_next_entry,         -- 開啟 diff 的下一個檔案
          ["<s-tab>"]    = actions.select_prev_entry,         -- 開啟 diff 的上一個檔案
          ["gf"]         = actions.goto_file,                 -- 開啟檔案在上一個標籤頁
          ["<C-w><C-f>"] = actions.goto_file_split,           -- 開啟檔案在新分割
          ["<C-w>gf"]    = actions.goto_file_tab,             -- 開啟檔案在新標籤頁
          ["<leader>e"]  = actions.focus_files,               -- 將游標移到檔案面板
          ["<leader>b"]  = actions.toggle_files,              -- 切換檔案面板
          ["g<C-x>"]     = actions.cycle_layout,              -- 循環佈局
          ["[x"]         = actions.prev_conflict,             -- 跳到上一個衝突
          ["]x"]         = actions.next_conflict,             -- 跳到下一個衝突
          ["<leader>co"] = actions.conflict_choose("ours"),   -- 選擇我們的版本
          ["<leader>ct"] = actions.conflict_choose("theirs"), -- 選擇他們的版本
          ["<leader>cb"] = actions.conflict_choose("base"),   -- 選擇基礎版本
          ["<leader>ca"] = actions.conflict_choose("all"),    -- 選擇所有版本
          ["dx"]         = actions.conflict_choose("none"),   -- 刪除衝突區域
        },
        diff1 = {
          -- diff1 佈局的按鍵映射
          ["g?"] = actions.help({ "view", "diff1" }),
        },
        diff2 = {
          -- diff2 佈局的按鍵映射
          ["g?"] = actions.help({ "view", "diff2" }),
        },
        diff3 = {
          -- diff3 佈局的按鍵映射
          ["g?"] = actions.help({ "view", "diff3" }),
        },
        diff4 = {
          -- diff4 佈局的按鍵映射
          ["g?"] = actions.help({ "view", "diff4" }),
        },
        file_panel = {
          ["j"]             = actions.next_entry,           -- 移到下一個檔案條目
          ["<down>"]        = actions.next_entry,
          ["k"]             = actions.prev_entry,           -- 移到上一個檔案條目
          ["<up>"]          = actions.prev_entry,
          ["<cr>"]          = actions.select_entry,         -- 開啟 diff 的檔案
          ["o"]             = actions.select_entry,
          ["<2-LeftMouse>"] = actions.select_entry,
          ["-"]             = actions.toggle_stage_entry,   -- 暫存/取消暫存選定條目
          ["S"]             = actions.stage_all,            -- 暫存所有條目
          ["U"]             = actions.unstage_all,          -- 取消暫存所有條目
          ["X"]             = actions.restore_entry,        -- 恢復條目到 index 狀態
          ["L"]             = actions.open_commit_log,      -- 開啟提交日誌面板
          ["zo"]            = actions.open_fold,
          ["zc"]            = actions.close_fold,
          ["za"]            = actions.toggle_fold,
          ["zR"]            = actions.expand_all_folds,
          ["zM"]            = actions.collapse_all_folds,
          ["<c-b>"]         = actions.scroll_view(-0.25),   -- 向上滾動檢視
          ["<c-f>"]         = actions.scroll_view(0.25),    -- 向下滾動檢視
          ["<tab>"]         = actions.select_next_entry,
          ["<s-tab>"]       = actions.select_prev_entry,
          ["gf"]            = actions.goto_file,
          ["<C-w><C-f>"]    = actions.goto_file_split,
          ["<C-w>gf"]       = actions.goto_file_tab,
          ["i"]             = actions.listing_style,        -- 切換檔案列表樣式
          ["f"]             = actions.toggle_flatten_dirs,  -- 切換目錄壓縮
          ["R"]             = actions.refresh_files,        -- 更新檔案列表
          ["<leader>e"]     = actions.focus_files,
          ["<leader>b"]     = actions.toggle_files,
          ["g<C-x>"]        = actions.cycle_layout,
          ["[x"]            = actions.prev_conflict,
          ["]x"]            = actions.next_conflict,
          ["g?"]            = actions.help("file_panel"),
        },
        file_history_panel = {
          ["g!"]            = actions.options,            -- 開啟選項面板
          ["<C-A-d>"]       = actions.open_in_diffview,   -- 在 diffview 中開啟條目
          ["y"]             = actions.copy_hash,          -- 複製提交雜湊
          ["L"]             = actions.open_commit_log,
          ["zR"]            = actions.expand_all_folds,
          ["zM"]            = actions.collapse_all_folds,
          ["j"]             = actions.next_entry,
          ["<down>"]        = actions.next_entry,
          ["k"]             = actions.prev_entry,
          ["<up>"]          = actions.prev_entry,
          ["<cr>"]          = actions.select_entry,
          ["o"]             = actions.select_entry,
          ["<2-LeftMouse>"] = actions.select_entry,
          ["<c-b>"]         = actions.scroll_view(-0.25),
          ["<c-f>"]         = actions.scroll_view(0.25),
          ["<tab>"]         = actions.select_next_entry,
          ["<s-tab>"]       = actions.select_prev_entry,
          ["gf"]            = actions.goto_file,
          ["<C-w><C-f>"]    = actions.goto_file_split,
          ["<C-w>gf"]       = actions.goto_file_tab,
          ["<leader>e"]     = actions.focus_files,
          ["<leader>b"]     = actions.toggle_files,
          ["g<C-x>"]        = actions.cycle_layout,
          ["g?"]            = actions.help("file_history_panel"),
        },
        option_panel = {
          ["<tab>"] = actions.select_entry,
          ["q"]     = actions.close,
          ["g?"]    = actions.help("option_panel"),
        },
      },
    })

    -- Diffview 按鍵映射
    vim.keymap.set("n", "<leader>dv", ":DiffviewOpen<CR>", { desc = "開啟 Diffview" })
    vim.keymap.set("n", "<leader>dc", ":DiffviewClose<CR>", { desc = "關閉 Diffview" })
    vim.keymap.set("n", "<leader>dh", ":DiffviewFileHistory<CR>", { desc = "檔案歷史" })
    vim.keymap.set("n", "<leader>dH", ":DiffviewFileHistory %<CR>", { desc = "當前檔案歷史" })
    vim.keymap.set("n", "<leader>dr", ":DiffviewRefresh<CR>", { desc = "重新整理 Diffview" })
    vim.keymap.set("n", "<leader>df", ":DiffviewToggleFiles<CR>", { desc = "切換檔案面板" })
  end,
}
```

### 步驟 4: 現代 Git 介面 - neogit (可選)
**位置**: `lua/plugins/neogit.lua`

```lua
return {
  "TimUntersberger/neogit",
  dependencies = {
    "nvim-lua/plenary.nvim",
    "sindrets/diffview.nvim",
    "nvim-telescope/telescope.nvim",
  },
  cmd = "Neogit",
  opts = {
    disable_signs = false,
    disable_hint = false,
    disable_context_highlighting = false,
    disable_commit_confirmation = false,
    disable_builtin_notifications = false,
    auto_refresh = true,
    disable_insert_on_commit = "auto",
    use_magit_keybindings = false,
    commit_popup = {
      kind = "split",
    },
    popup = {
      kind = "split",
    },
    signs = {
      section = { "", "" },
      item = { "", "" },
      hunk = { "", "" },
    },
    integrations = {
      diffview = true,
      telescope = true,
    },
    sections = {
      untracked = {
        folded = false
      },
      unstaged = {
        folded = false
      },
      staged = {
        folded = false
      },
      stashes = {
        folded = true
      },
      unpulled = {
        folded = true
      },
      unmerged = {
        folded = false
      },
      recent = {
        folded = true
      },
    },
  },
  config = function(_, opts)
    require("neogit").setup(opts)
    
    vim.keymap.set("n", "<leader>gg", ":Neogit<CR>", { desc = "開啟 Neogit" })
    vim.keymap.set("n", "<leader>gG", ":Neogit kind=tab<CR>", { desc = "在新標籤頁開啟 Neogit" })
  end,
}
```

## 驗證與測試

### 基本功能測試
1. **Gitsigns 測試**:
   ```bash
   # 修改檔案
   echo "test change" >> test.txt
   # 應該在編輯器左側看到變更標記
   ```

2. **Fugitive 測試**:
   ```vim
   <leader>gs
   # 應該開啟 Git 狀態視窗
   ```

3. **Diffview 測試**:
   ```vim
   <leader>dv
   # 應該開啟差異檢視
   ```

### Git 工作流程測試
```bash
# 完整 Git 工作流程測試
git checkout -b test-branch
echo "new feature" > feature.txt
# 使用 Neovim 的 Git 功能進行提交和推送
```

## 按鍵映射總結

### Gitsigns 相關
- `]c` / `[c` - 下一個/上一個 Git hunk
- `<leader>hs` - 暫存 hunk
- `<leader>hr` - 重置 hunk
- `<leader>hp` - 預覽 hunk
- `<leader>hb` - 責任歸屬當前行
- `<leader>tb` - 切換當前行 blame

### Fugitive 相關
- `<leader>gs` - Git 狀態
- `<leader>gc` - Git 提交
- `<leader>gp` - Git 推送
- `<leader>gP` - Git 拉取
- `<leader>gb` - 分支列表
- `<leader>gl` - Git 日誌
- `<leader>gd` - Git diff
- `<leader>gB` - Git blame

### Diffview 相關
- `<leader>dv` - 開啟 Diffview
- `<leader>dc` - 關閉 Diffview
- `<leader>dh` - 檔案歷史
- `<leader>df` - 切換檔案面板

### Neogit 相關 (可選)
- `<leader>gg` - 開啟 Neogit
- `<leader>gG` - 在新標籤頁開啟 Neogit

## 常見問題與解決方案

### Q1: Git 狀態不顯示
**檢查項目**:
1. 確認在 Git 倉庫中: `git status`
2. 檢查檔案是否被 Git 追蹤
3. 重新載入 gitsigns: `:Gitsigns refresh`

### Q2: Fugitive 指令失敗
**解決方案**:
1. 檢查 Git 版本: `git --version`
2. 確認 Git 配置正確
3. 檢查倉庫權限

### Q3: Diffview 效能問題
**優化方案**:
```lua
-- 在 diffview 設置中添加
git_cmd = { "git", "--no-pager" },
enhanced_diff_hl = false,
```

### Q4: 合併衝突解決
**步驟**:
1. 使用 `:DiffviewOpen` 檢視衝突
2. 使用 `<leader>co` / `<leader>ct` 選擇版本
3. 使用 `:Git add .` 標記為已解決
4. 使用 `:Git commit` 完成合併

## 進階工作流程

### 功能分支工作流程
```vim
" 1. 建立新分支
:Git checkout -b feature/new-feature

" 2. 開發過程中查看變更
<leader>hs  " 暫存變更
<leader>hp  " 預覽變更

" 3. 提交變更
<leader>gs  " 檢視狀態
<leader>gc  " 提交

" 4. 推送分支
<leader>gp  " 推送

" 5. 合併前檢視差異
<leader>dv  " 檢視與主分支的差異
```

### 衝突解決工作流程
```vim
" 1. 拉取最新變更時發生衝突
<leader>gP  " 拉取

" 2. 使用 Diffview 解決衝突
<leader>dv  " 開啟差異檢視

" 3. 在衝突檔案中選擇版本
<leader>co  " 選擇我們的版本
<leader>ct  " 選擇他們的版本

" 4. 完成合併
<leader>gs  " 檢視狀態
<leader>gc  " 提交合併
```

## 檢查清單
- [ ] Gitsigns 行內狀態顯示正常
- [ ] Fugitive Git 指令功能正常
- [ ] Diffview 差異檢視正常
- [ ] Git 工作流程整合順暢
- [ ] 按鍵映射設置完成
- [ ] 衝突解決功能正常
- [ ] 效能表現良好

## 與其他模組的集成
- **檔案管理**: nvim-tree 顯示 Git 狀態
- **模糊搜尋**: Telescope 的 Git 相關搜尋器
- **狀態列**: 顯示當前分支和變更統計
- **LSP 系統**: 整合 Git blame 資訊