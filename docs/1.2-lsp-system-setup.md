# 1.2 LSP 系統設置企劃書 - mason.nvim + nvim-lspconfig + conform.nvim + nvim-lint

## 專案概覽
建立完整的 Language Server Protocol (LSP) 系統，提供智能語言支援功能，包括自動安裝語言伺服器、代碼跳轉、錯誤檢查、懸浮文檔和代碼格式化。

## 目標與預期成果
- ✅ 自動管理和安裝語言伺服器
- ✅ 實現代碼跳轉 (definition/reference/declaration)
- ✅ 即時錯誤檢查和診斷
- ✅ 懸浮文檔和簽名幫助
- ✅ 代碼格式化和重構
- ✅ 符號搜尋和導航

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- Neovim 0.8+ 版本
- Node.js (部分語言伺服器需要)
- Python 3.6+ (部分語言伺服器需要)

## 核心套件組合
1. **mason.nvim** - 語言伺服器、DAP、linter、formatter 管理器
2. **mason-lspconfig.nvim** - mason.nvim 與 lspconfig 的橋接器
3. **nvim-lspconfig** - LSP 客戶端配置
4. **conform.nvim** - 現代格式化引擎 (2024 推薦)
5. **nvim-lint** - 專用 linting 引擎 (2024 推薦)

### 技術選擇說明
採用 **conform.nvim + nvim-lint** 組合替代 none-ls/null-ls：
- **更好的效能**: 專業化工具各司其職
- **主動維護**: 兩個插件都有活躍的社群支援
- **現代標準**: LazyVim 等主要發行版已採用此組合
- **長期支援**: null-ls 已停止維護，none-ls 為社群維護分支

## 實施步驟

### 步驟 1: 建立 LSP 系統配置檔案
**位置**: `lua/plugins/lsp.lua`

```lua
return {
  -- Mason - 語言伺服器管理器
  {
    "williamboman/mason.nvim",
    cmd = "Mason",
    keys = { { "<leader>cm", "<cmd>Mason<cr>", desc = "Mason" } },
    build = ":MasonUpdate",
    opts = {
      ensure_installed = {
        -- 基本工具
        "lua-language-server",  -- Lua LSP
        "stylua",              -- Lua formatter
      },
    },
    config = function(_, opts)
      require("mason").setup(opts)
      local mr = require("mason-registry")
      mr:on("package:install:success", function()
        vim.defer_fn(function()
          -- 觸發 FileType 事件以可能啟動新安裝的伺服器
          require("lazy.core.handler.event").trigger({
            event = "FileType",
            buf = vim.api.nvim_get_current_buf(),
          })
        end, 100)
      end)
      local function ensure_installed()
        for _, tool in ipairs(opts.ensure_installed) do
          local p = mr.get_package(tool)
          if not p:is_installed() then
            p:install()
          end
        end
      end
      if mr.refresh then
        mr.refresh(ensure_installed)
      else
        ensure_installed()
      end
    end,
  },

  -- Mason-LSPConfig 橋接器
  {
    "williamboman/mason-lspconfig.nvim",
    dependencies = { "mason.nvim" },
    opts = {
      automatic_installation = true,
      ensure_installed = {
        "lua_ls",  -- Lua
      },
    },
  },
```

### 步驟 2: LSP 配置和按鍵映射
**繼續在**: `lua/plugins/lsp.lua` **文件中添加**

```lua
  -- LSP 配置
  {
    "neovim/nvim-lspconfig",
  event = { "BufReadPre", "BufNewFile" },
  dependencies = {
    "mason.nvim",
    "williamboman/mason-lspconfig.nvim",
    { "folke/neodev.nvim", opts = {} }, -- Lua 開發增強
  },
  config = function()
    local lspconfig = require("lspconfig")
    local mason_lspconfig = require("mason-lspconfig")

    -- LSP 附加時的按鍵映射
    local on_attach = function(client, bufnr)
      local opts = { buffer = bufnr, silent = true }
      
      -- 導航
      vim.keymap.set("n", "gd", vim.lsp.buf.definition, opts)
      vim.keymap.set("n", "gD", vim.lsp.buf.declaration, opts)
      vim.keymap.set("n", "gi", vim.lsp.buf.implementation, opts)
      vim.keymap.set("n", "gr", vim.lsp.buf.references, opts)
      vim.keymap.set("n", "K", vim.lsp.buf.hover, opts)
      vim.keymap.set("n", "<C-k>", vim.lsp.buf.signature_help, opts)
      
      -- 工作區
      vim.keymap.set("n", "<leader>wa", vim.lsp.buf.add_workspace_folder, opts)
      vim.keymap.set("n", "<leader>wr", vim.lsp.buf.remove_workspace_folder, opts)
      vim.keymap.set("n", "<leader>wl", function()
        print(vim.inspect(vim.lsp.buf.list_workspace_folders()))
      end, opts)
      
      -- 代碼操作
      vim.keymap.set("n", "<leader>D", vim.lsp.buf.type_definition, opts)
      vim.keymap.set("n", "<leader>rn", vim.lsp.buf.rename, opts)
      vim.keymap.set({ "n", "v" }, "<leader>ca", vim.lsp.buf.code_action, opts)
      -- 注意：格式化功能由 conform.nvim 處理
      -- LSP 格式化已整合到 conform.nvim 中作為 fallback
      
      -- 診斷
      vim.keymap.set("n", "[d", vim.diagnostic.goto_prev, opts)
      vim.keymap.set("n", "]d", vim.diagnostic.goto_next, opts)
      vim.keymap.set("n", "<leader>e", vim.diagnostic.open_float, opts)
      vim.keymap.set("n", "<leader>q", vim.diagnostic.setloclist, opts)
    end

    -- LSP 功能增強
    local capabilities = vim.lsp.protocol.make_client_capabilities()
    -- 如果有 nvim-cmp，取消註解下面這行
    -- capabilities = require('cmp_nvim_lsp').default_capabilities(capabilities)

    -- 診斷設置
    vim.diagnostic.config({
      underline = true,
      update_in_insert = false,
      virtual_text = {
        spacing = 4,
        source = "if_many",
        prefix = "●",
      },
      severity_sort = true,
      signs = {
        text = {
          [vim.diagnostic.severity.ERROR] = "✘",
          [vim.diagnostic.severity.WARN] = "▲",
          [vim.diagnostic.severity.HINT] = "⚑",
          [vim.diagnostic.severity.INFO] = "»",
        },
      },
    })

    -- 自動設置語言伺服器
    mason_lspconfig.setup_handlers({
      -- 預設處理器
      function(server_name)
        lspconfig[server_name].setup({
          on_attach = on_attach,
          capabilities = capabilities,
        })
      end,

      -- Lua 語言伺服器配置
      ["lua_ls"] = function()
        lspconfig.lua_ls.setup({
          on_attach = on_attach,
          capabilities = capabilities,
          settings = {
            Lua = {
              runtime = { version = "LuaJIT" },
              workspace = {
                checkThirdParty = false,
                library = {
                  "${3rd}/luv/library",
                  unpack(vim.api.nvim_get_runtime_file("", true)),
                },
              },
              completion = { callSnippet = "Replace" },
              telemetry = { enable = false },
            },
          },
        })
      end,
    })
  end,

  -- 格式化支援 - conform.nvim
  {
    "stevearc/conform.nvim",
    event = { "BufReadPre", "BufNewFile" },
    keys = {
      {
        "<leader>f",
        function()
          require("conform").format({ async = true, lsp_fallback = true })
        end,
        mode = { "n", "v" },
        desc = "格式化文件或範圍",
      },
    },
    config = function()
      require("conform").setup({
        formatters_by_ft = {
          lua = { "stylua" },
        },
        -- 格式化選項
        format_on_save = {
          timeout_ms = 500,
          lsp_fallback = true,
        },
      })
    end,
  },

  -- Linting 支援 - nvim-lint
  {
    "mfussenegger/nvim-lint",
    event = { "BufReadPre", "BufNewFile" },
    config = function()
      local lint = require("lint")
      
      -- 配置各檔案類型的 linter（目前僅 Lua 不需要額外 linter）
      lint.linters_by_ft = {
        -- Lua 使用 LSP 提供的診斷，不需要額外 linter
      }
      
      -- 自動 linting 事件
      local lint_augroup = vim.api.nvim_create_augroup("lint", { clear = true })
      vim.api.nvim_create_autocmd({ "BufEnterPost", "BufWritePost", "InsertLeave" }, {
        group = lint_augroup,
        callback = function()
          -- 只對支援的檔案類型執行 lint
          if lint.linters_by_ft[vim.bo.filetype] then
            lint.try_lint()
          end
        end,
      })
      
      -- 手動觸發 linting 的按鍵映射
      vim.keymap.set("n", "<leader>l", function()
        lint.try_lint()
      end, { desc = "手動執行 Linting" })
    end,
  },
}
```

### 步驟 3: LSP 相關按鍵映射
**位置**: `lua/core/keymaps.lua` (新增)

```lua
-- LSP 相關按鍵映射
vim.keymap.set("n", "<leader>li", ":LspInfo<cr>", { desc = "LSP 資訊" })
vim.keymap.set("n", "<leader>lr", ":LspRestart<cr>", { desc = "重啟 LSP" })
vim.keymap.set("n", "<leader>lm", ":Mason<cr>", { desc = "開啟 Mason" })

-- 診斷相關
vim.keymap.set("n", "<leader>dd", function()
  vim.diagnostic.open_float(nil, { focus = false })
end, { desc = "顯示診斷" })
vim.keymap.set("n", "<leader>dl", function()
  vim.diagnostic.setloclist()
end, { desc = "診斷列表" })

-- 格式化和 Linting
vim.keymap.set({ "n", "v" }, "<leader>f", function()
  require("conform").format({ async = true, lsp_fallback = true })
end, { desc = "格式化文件" })
vim.keymap.set("n", "<leader>l", function()
  require("lint").try_lint()
end, { desc = "執行 Linting" })
```

## 驗證與測試

### 基本功能驗證
1. **LSP 啟動測試**:
   ```vim
   :LspInfo
   # 檢查 LSP 是否正確附加到緩衝區
   ```

2. **Mason 介面測試**:
   ```vim
   :Mason
   # 檢查語言伺服器、formatter、linter 安裝狀態
   ```

3. **格式化測試**:
   ```vim
   :ConformInfo
   # 檢查 conform.nvim 狀態和可用 formatter
   ```

4. **功能測試**:
   - 開啟 .lua 檔案
   - 測試 `K` (懸浮文檔)
   - 測試 `gd` (跳轉定義)
   - 測試 `<leader>ca` (代碼操作)
   - 測試 `<leader>f` (格式化)

### Lua 語言測試
```lua
-- 測試 Lua LSP (創建 test.lua)
local function test_function()
  print("Hello, World!")
end

test_function() -- 游標停在 test_function() 上按 gd 應該跳轉到定義

-- 測試格式化：故意寫得格式不整齊，然後按 <leader>f 格式化
local   messy_table={a=1,b=2,c=3}
```

## 支援的語言伺服器列表

### 預設安裝
- **lua_ls** - Lua 語言支援
- **stylua** - Lua 格式化工具

### 按需添加其他語言
根據需要可以添加更多語言支援：
```lua
-- 在 mason-lspconfig ensure_installed 中添加
"pyright",    -- Python
"tsserver",   -- TypeScript/JavaScript
"gopls",      -- Go
"rust_analyzer", -- Rust
"clangd",     -- C/C++
"bashls",     -- Bash

-- 在 mason ensure_installed 中添加對應工具
"black",      -- Python formatter
"prettier",   -- JS/TS formatter
"eslint_d",   -- JS/TS linter
-- 等等...
```

## 常見問題與解決方案

### Q1: 語言伺服器安裝失敗
**解決方案**:
```vim
:Mason
# 在 Mason 介面中手動安裝失敗的伺服器
```

### Q2: LSP 功能不正常
**檢查步驟**:
1. `:LspInfo` - 檢查 LSP 狀態
2. `:checkhealth lsp` - 檢查 LSP 健康狀態
3. `:messages` - 查看錯誤訊息

### Q3: 格式化不工作
**解決方案**:
1. 確認 conform.nvim 已正確安裝
2. 檢查對應的 formatter 是否已透過 Mason 安裝
3. 使用 `:ConformInfo` 查看狀態
4. 檢查 `formatters_by_ft` 配置是否正確

### Q4: 需要添加其他語言支援
**步驟**:
1. 在 Mason 中安裝對應的 LSP server
2. 添加到 `mason-lspconfig` 的 `ensure_installed` 中
3. 如需格式化，添加 formatter 到 `conform.nvim` 配置
4. 如需 linting，添加 linter 到 `nvim-lint` 配置

### Q5: 診斷訊息過多或不足
**調整方案**:
```lua
-- 在 lspconfig.lua 中調整診斷設置
vim.diagnostic.config({
  virtual_text = false, -- 關閉虛擬文字
  -- 或
  virtual_text = {
    severity = { min = vim.diagnostic.severity.WARN }, -- 只顯示警告以上
  },
})
```

## 效能優化建議

1. **延遲載入**: 使用 `event = { "BufReadPre", "BufNewFile" }`
2. **條件載入**: 只在需要的檔案類型載入特定 LSP
3. **記憶體管理**: 定期重啟不常用的 LSP

## 擴展功能

### LSP 進度指示器
```lua
-- 可選：添加 LSP 進度顯示
{
  "j-hui/fidget.nvim",
  opts = {},
}
```

### 符號大綱
```lua
-- 可選：添加符號導航
{
  "stevearc/aerial.nvim",
  opts = {},
  dependencies = {
    "nvim-treesitter/nvim-treesitter",
    "nvim-tree/nvim-web-devicons"
  },
}
```

## 檢查清單
- [ ] Mason 安裝成功
- [ ] lua_ls (Lua 語言伺服器) 安裝完成
- [ ] stylua (Lua 格式化工具) 安裝完成
- [ ] LSP 功能正常 (跳轉、懸浮文檔、診斷)
- [ ] conform.nvim Lua 格式化功能正常
- [ ] 按鍵映射設置完成
- [ ] 自動格式化正常
- [ ] 錯誤處理機制正常
- [ ] 效能表現良好

## 後續集成
此 LSP 系統將與以下模組無縫集成：
- 1.3 自動完成系統 (nvim-cmp) - 提供 LSP 補全源
- 1.4 模糊搜尋 (telescope.nvim) - LSP 符號搜尋
- 2.3 除錯支援 (nvim-dap) - 語言特定除錯配置