# 1.2 LSP 系統設置企劃書 - mason.nvim + nvim-lspconfig

## 專案概覽
建立完整的 Language Server Protocol (LSP) 系統，提供智能語言支援功能，包括自動安裝語言伺服器、代碼跳轉、錯誤檢查、懸浮文檔和代碼格式化。

## 目標與預期成果
- ✅ 自動管理和安裝語言伺服器
- ✅ 實現代碼跳轉 (definition/reference/declaration)
- ✅ 即時錯誤檢查和診斷
- ✅ 懸浮文檔和簽名幫助
- ✅ 代碼格式化和重構
- ✅ 符號搜尋和導航

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- Neovim 0.8+ 版本
- Node.js (部分語言伺服器需要)
- Python 3.6+ (部分語言伺服器需要)

## 核心套件組合
1. **mason.nvim** - 語言伺服器、DAP、linter、formatter 管理器
2. **mason-lspconfig.nvim** - mason.nvim 與 lspconfig 的橋接器
3. **nvim-lspconfig** - LSP 客戶端配置
4. **none-ls.nvim** - 格式化和 linting (替代已廢棄的 null-ls)

## 實施步驟

### 步驟 1: 建立 LSP 系統配置檔案
**位置**: `lua/plugins/lsp.lua`

```lua
return {
  -- Mason - 語言伺服器管理器
  {
    "williamboman/mason.nvim",
    cmd = "Mason",
    keys = { { "<leader>cm", "<cmd>Mason<cr>", desc = "Mason" } },
    build = ":MasonUpdate",
    opts = {
      ensure_installed = {
        -- 基本語言伺服器
        "lua-language-server",
        "stylua",
        "shfmt",
        "shellcheck",
        -- 根據需要添加更多
      },
    },
    config = function(_, opts)
      require("mason").setup(opts)
      local mr = require("mason-registry")
      mr:on("package:install:success", function()
        vim.defer_fn(function()
          -- 觸發 FileType 事件以可能啟動新安裝的伺服器
          require("lazy.core.handler.event").trigger({
            event = "FileType",
            buf = vim.api.nvim_get_current_buf(),
          })
        end, 100)
      end)
      local function ensure_installed()
        for _, tool in ipairs(opts.ensure_installed) do
          local p = mr.get_package(tool)
          if not p:is_installed() then
            p:install()
          end
        end
      end
      if mr.refresh then
        mr.refresh(ensure_installed)
      else
        ensure_installed()
      end
    end,
  },

  -- Mason-LSPConfig 橋接器
  {
    "williamboman/mason-lspconfig.nvim",
    dependencies = { "mason.nvim" },
    opts = {
      automatic_installation = true,
      ensure_installed = {
        "lua_ls",     -- Lua
        "pyright",    -- Python
        "tsserver",   -- TypeScript/JavaScript
        "gopls",      -- Go
        "rust_analyzer", -- Rust
        "clangd",     -- C/C++
        "bashls",     -- Bash
      },
    },
  },
```

### 步驟 2: LSP 配置和按鍵映射
**繼續在**: `lua/plugins/lsp.lua` **文件中添加**

```lua
  -- LSP 配置
  {
    "neovim/nvim-lspconfig",
  event = { "BufReadPre", "BufNewFile" },
  dependencies = {
    "mason.nvim",
    "williamboman/mason-lspconfig.nvim",
    { "folke/neodev.nvim", opts = {} }, -- Lua 開發增強
  },
  config = function()
    local lspconfig = require("lspconfig")
    local mason_lspconfig = require("mason-lspconfig")

    -- LSP 附加時的按鍵映射
    local on_attach = function(client, bufnr)
      local opts = { buffer = bufnr, silent = true }
      
      -- 導航
      vim.keymap.set("n", "gd", vim.lsp.buf.definition, opts)
      vim.keymap.set("n", "gD", vim.lsp.buf.declaration, opts)
      vim.keymap.set("n", "gi", vim.lsp.buf.implementation, opts)
      vim.keymap.set("n", "gr", vim.lsp.buf.references, opts)
      vim.keymap.set("n", "K", vim.lsp.buf.hover, opts)
      vim.keymap.set("n", "<C-k>", vim.lsp.buf.signature_help, opts)
      
      -- 工作區
      vim.keymap.set("n", "<leader>wa", vim.lsp.buf.add_workspace_folder, opts)
      vim.keymap.set("n", "<leader>wr", vim.lsp.buf.remove_workspace_folder, opts)
      vim.keymap.set("n", "<leader>wl", function()
        print(vim.inspect(vim.lsp.buf.list_workspace_folders()))
      end, opts)
      
      -- 代碼操作
      vim.keymap.set("n", "<leader>D", vim.lsp.buf.type_definition, opts)
      vim.keymap.set("n", "<leader>rn", vim.lsp.buf.rename, opts)
      vim.keymap.set({ "n", "v" }, "<leader>ca", vim.lsp.buf.code_action, opts)
      vim.keymap.set("n", "<leader>f", function()
        vim.lsp.buf.format { async = true }
      end, opts)
      
      -- 診斷
      vim.keymap.set("n", "[d", vim.diagnostic.goto_prev, opts)
      vim.keymap.set("n", "]d", vim.diagnostic.goto_next, opts)
      vim.keymap.set("n", "<leader>e", vim.diagnostic.open_float, opts)
      vim.keymap.set("n", "<leader>q", vim.diagnostic.setloclist, opts)
    end

    -- LSP 功能增強
    local capabilities = vim.lsp.protocol.make_client_capabilities()
    -- 如果有 nvim-cmp，取消註解下面這行
    -- capabilities = require('cmp_nvim_lsp').default_capabilities(capabilities)

    -- 診斷設置
    vim.diagnostic.config({
      underline = true,
      update_in_insert = false,
      virtual_text = {
        spacing = 4,
        source = "if_many",
        prefix = "●",
      },
      severity_sort = true,
      signs = {
        text = {
          [vim.diagnostic.severity.ERROR] = "✘",
          [vim.diagnostic.severity.WARN] = "▲",
          [vim.diagnostic.severity.HINT] = "⚑",
          [vim.diagnostic.severity.INFO] = "»",
        },
      },
    })

    -- 自動設置語言伺服器
    mason_lspconfig.setup_handlers({
      -- 預設處理器
      function(server_name)
        lspconfig[server_name].setup({
          on_attach = on_attach,
          capabilities = capabilities,
        })
      end,

      -- 特定語言伺服器的自訂配置
      ["lua_ls"] = function()
        lspconfig.lua_ls.setup({
          on_attach = on_attach,
          capabilities = capabilities,
          settings = {
            Lua = {
              runtime = { version = "LuaJIT" },
              workspace = {
                checkThirdParty = false,
                library = {
                  "${3rd}/luv/library",
                  unpack(vim.api.nvim_get_runtime_file("", true)),
                },
              },
              completion = { callSnippet = "Replace" },
              telemetry = { enable = false },
              hint = { enable = true },
            },
          },
        })
      end,

      ["pyright"] = function()
        lspconfig.pyright.setup({
          on_attach = on_attach,
          capabilities = capabilities,
          settings = {
            python = {
              analysis = {
                autoSearchPaths = true,
                diagnosticMode = "workspace",
                useLibraryCodeForTypes = true,
              },
            },
          },
        })
      end,

      ["tsserver"] = function()
        lspconfig.tsserver.setup({
          on_attach = on_attach,
          capabilities = capabilities,
          settings = {
            typescript = {
              inlayHints = {
                includeInlayParameterNameHints = "all",
                includeInlayParameterNameHintsWhenArgumentMatchesName = false,
                includeInlayFunctionParameterTypeHints = true,
                includeInlayVariableTypeHints = true,
                includeInlayPropertyDeclarationTypeHints = true,
                includeInlayFunctionLikeReturnTypeHints = true,
                includeInlayEnumMemberValueHints = true,
              },
            },
            javascript = {
              inlayHints = {
                includeInlayParameterNameHints = "all",
                includeInlayParameterNameHintsWhenArgumentMatchesName = false,
                includeInlayFunctionParameterTypeHints = true,
                includeInlayVariableTypeHints = true,
                includeInlayPropertyDeclarationTypeHints = true,
                includeInlayFunctionLikeReturnTypeHints = true,
                includeInlayEnumMemberValueHints = true,
              },
            },
          },
        })
      end,
    })
  end,

  -- 格式化和 Linting 支援
  {
    "nvimtools/none-ls.nvim",
  event = { "BufReadPre", "BufNewFile" },
  dependencies = { "mason.nvim" },
  config = function()
    local null_ls = require("null-ls")
    
    null_ls.setup({
      sources = {
        -- Lua
        null_ls.builtins.formatting.stylua,
        
        -- Shell
        null_ls.builtins.formatting.shfmt,
        null_ls.builtins.diagnostics.shellcheck,
        
        -- Python
        null_ls.builtins.formatting.black,
        null_ls.builtins.formatting.isort,
        null_ls.builtins.diagnostics.flake8,
        
        -- JavaScript/TypeScript
        null_ls.builtins.formatting.prettier,
        null_ls.builtins.diagnostics.eslint,
        
        -- 根據需要添加更多
      },
      on_attach = function(client, bufnr)
        if client.supports_method("textDocument/formatting") then
          vim.keymap.set("n", "<leader>f", function()
            vim.lsp.buf.format({ bufnr = bufnr })
          end, { buffer = bufnr, desc = "格式化文件" })
        end
      end,
    })
  end,
}
```

### 步驟 3: LSP 相關按鍵映射
**位置**: `lua/core/keymaps.lua` (新增)

```lua
-- LSP 相關按鍵映射
vim.keymap.set("n", "<leader>li", ":LspInfo<cr>", { desc = "LSP 資訊" })
vim.keymap.set("n", "<leader>lr", ":LspRestart<cr>", { desc = "重啟 LSP" })
vim.keymap.set("n", "<leader>lm", ":Mason<cr>", { desc = "開啟 Mason" })

-- 診斷相關
vim.keymap.set("n", "<leader>dd", function()
  vim.diagnostic.open_float(nil, { focus = false })
end, { desc = "顯示診斷" })
vim.keymap.set("n", "<leader>dl", function()
  vim.diagnostic.setloclist()
end, { desc = "診斷列表" })
```

## 驗證與測試

### 基本功能驗證
1. **LSP 啟動測試**:
   ```vim
   :LspInfo
   # 檢查 LSP 是否正確附加到緩衝區
   ```

2. **Mason 介面測試**:
   ```vim
   :Mason
   # 檢查語言伺服器安裝狀態
   ```

3. **功能測試**:
   - 開啟支援的檔案類型 (如 .lua, .py, .js)
   - 測試 `K` (懸浮文檔)
   - 測試 `gd` (跳轉定義)
   - 測試 `<leader>ca` (代碼操作)

### 語言特定測試
```lua
-- 測試 Lua LSP (創建 test.lua)
local function test()
  print("Hello, World!")
end

test() -- 游標停在 test() 上按 gd 應該跳轉到定義
```

## 支援的語言伺服器列表

### 預設安裝
- **lua_ls** - Lua 語言支援
- **pyright** - Python 語言支援
- **tsserver** - TypeScript/JavaScript 支援
- **gopls** - Go 語言支援
- **rust_analyzer** - Rust 語言支援
- **clangd** - C/C++ 語言支援
- **bashls** - Bash 腳本支援

### 按需添加
```lua
-- 在 mason.lua 的 ensure_installed 中添加
"html-lsp",        -- HTML
"css-lsp",         -- CSS
"json-lsp",        -- JSON
"yaml-language-server", -- YAML
"dockerfile-language-server", -- Docker
```

## 常見問題與解決方案

### Q1: 語言伺服器安裝失敗
**解決方案**:
```vim
:Mason
# 在 Mason 介面中手動安裝失敗的伺服器
```

### Q2: LSP 功能不正常
**檢查步驟**:
1. `:LspInfo` - 檢查 LSP 狀態
2. `:checkhealth lsp` - 檢查 LSP 健康狀態
3. `:messages` - 查看錯誤訊息

### Q3: 格式化不工作
**解決方案**:
1. 確認 none-ls 已正確安裝
2. 檢查對應的 formatter 是否已安裝
3. 使用 `:NullLsInfo` 查看狀態

### Q4: 診斷訊息過多或不足
**調整方案**:
```lua
-- 在 lspconfig.lua 中調整診斷設置
vim.diagnostic.config({
  virtual_text = false, -- 關閉虛擬文字
  -- 或
  virtual_text = {
    severity = { min = vim.diagnostic.severity.WARN }, -- 只顯示警告以上
  },
})
```

## 效能優化建議

1. **延遲載入**: 使用 `event = { "BufReadPre", "BufNewFile" }`
2. **條件載入**: 只在需要的檔案類型載入特定 LSP
3. **記憶體管理**: 定期重啟不常用的 LSP

## 擴展功能

### LSP 進度指示器
```lua
-- 可選：添加 LSP 進度顯示
{
  "j-hui/fidget.nvim",
  opts = {},
}
```

### 符號大綱
```lua
-- 可選：添加符號導航
{
  "stevearc/aerial.nvim",
  opts = {},
  dependencies = {
    "nvim-treesitter/nvim-treesitter",
    "nvim-tree/nvim-web-devicons"
  },
}
```

## 檢查清單
- [ ] Mason 安裝成功
- [ ] 基本語言伺服器安裝完成
- [ ] LSP 功能正常 (跳轉、懸浮文檔、診斷)
- [ ] 格式化功能正常
- [ ] 按鍵映射設置完成
- [ ] 錯誤處理機制正常
- [ ] 效能表現良好

## 後續集成
此 LSP 系統將與以下模組無縫集成：
- 1.3 自動完成系統 (nvim-cmp) - 提供 LSP 補全源
- 1.4 模糊搜尋 (telescope.nvim) - LSP 符號搜尋
- 2.3 除錯支援 (nvim-dap) - 語言特定除錯配置