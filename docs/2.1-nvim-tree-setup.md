# 2.1 檔案管理系統設置企劃書 - nvim-tree

## 專案概覽
建立圖形化檔案瀏覽器和管理系統，提供直觀的檔案樹側邊欄、檔案操作功能和 Git 狀態整合。

## 目標與預期成果
- ✅ 圖形化檔案樹側邊欄
- ✅ 檔案和目錄操作 (新增/刪除/重命名/複製)
- ✅ Git 狀態即時顯示
- ✅ 檔案搜尋和過濾
- ✅ 書籤和快速導航
- ✅ 與其他套件的無縫整合

## 前置需求
- 已完成 1.1 套件管理器設置 (lazy.nvim)
- 已完成 1.4 模糊搜尋設置 (telescope.nvim，可選)
- Nerd Font 字體 (用於圖示顯示)

## 核心套件組合
1. **nvim-tree.lua** - 檔案樹核心
2. **nvim-web-devicons** - 檔案類型圖示

## 實施步驟

### 步驟 1: 核心 nvim-tree 設置
**位置**: `lua/plugins/ui/nvim-tree.lua`

```lua
return {
  "nvim-tree/nvim-tree.lua",
  dependencies = "nvim-tree/nvim-web-devicons",
  event = "VeryLazy",
  config = function()
    -- 禁用 netrw (Vim 內建檔案瀏覽器)
    vim.g.loaded_netrw = 1
    vim.g.loaded_netrwPlugin = 1

    require("nvim-tree").setup({
      -- 基本設置
      auto_reload_on_write = true,
      disable_netrw = true,
      hijack_netrw = true,
      hijack_cursor = false,
      hijack_unnamed_buffer_when_opening = false,
      
      -- 開啟時的行為
      open_on_tab = false,
      hijack_directories = {
        enable = true,
        auto_open = true,
      },

      -- 同步設置
      sync_root_with_cwd = true,
      reload_on_bufenter = false,
      respect_buf_cwd = true,

      -- 視窗設置
      view = {
        width = 35,
        side = "left",
        preserve_window_proportions = false,
        number = false,
        relativenumber = false,
        signcolumn = "yes",
        float = {
          enable = false,
          quit_on_focus_loss = true,
          open_win_config = {
            relative = "editor",
            border = "rounded",
            width = 50,
            height = 30,
            row = 1,
            col = 1,
          },
        },
      },

      -- 渲染設置
      renderer = {
        add_trailing = false,
        group_empty = false,
        highlight_git = true,
        full_name = false,
        highlight_opened_files = "none",
        highlight_modified = "none",
        root_folder_label = ":~:s?$?/..?",
        indent_width = 2,
        indent_markers = {
          enable = true,
          inline_arrows = true,
          icons = {
            corner = "└",
            edge = "│",
            item = "│",
            bottom = "─",
            none = " ",
          },
        },
        icons = {
          webdev_colors = true,
          git_placement = "before",
          modified_placement = "after",
          padding = " ",
          symlink_arrow = " ➛ ",
          show = {
            file = true,
            folder = true,
            folder_arrow = true,
            git = true,
            modified = true,
          },
          glyphs = {
            default = "󰈚",
            symlink = "",
            bookmark = "󰆤",
            modified = "●",
            folder = {
              arrow_closed = "",
              arrow_open = "",
              default = "",
              open = "",
              empty = "",
              empty_open = "",
              symlink = "",
              symlink_open = "",
            },
            git = {
              unstaged = "✗",
              staged = "✓",
              unmerged = "",
              renamed = "➜",
              untracked = "★",
              deleted = "",
              ignored = "◌",
            },
          },
        },
        special_files = { "Cargo.toml", "Makefile", "README.md", "readme.md" },
        symlink_destination = true,
      },

      -- Git 整合
      git = {
        enable = true,
        ignore = true,
        show_on_dirs = true,
        show_on_open_dirs = true,
        timeout = 400,
      },

      -- 診斷整合
      diagnostics = {
        enable = true,
        show_on_dirs = false,
        show_on_open_dirs = true,
        debounce_delay = 50,
        severity = {
          min = vim.diagnostic.severity.HINT,
          max = vim.diagnostic.severity.ERROR,
        },
        icons = {
          hint = "",
          info = "",
          warning = "",
          error = "",
        },
      },

      -- 修改文件
      modified = {
        enable = true,
        show_on_dirs = true,
        show_on_open_dirs = true,
      },

      -- 過濾器
      filters = {
        dotfiles = false,
        git_clean = false,
        no_buffer = false,
        custom = {},
        exclude = {},
      },

      -- 檔案系統觀察器
      filesystem_watchers = {
        enable = true,
        debounce_delay = 50,
        ignore_dirs = {},
      },

      -- 操作設置
      actions = {
        use_system_clipboard = true,
        change_dir = {
          enable = true,
          global = false,
          restrict_above_cwd = false,
        },
        expand_all = {
          max_folder_discovery = 300,
          exclude = {},
        },
        file_popup = {
          open_win_config = {
            col = 1,
            row = 1,
            relative = "cursor",
            border = "shadow",
            style = "minimal",
          },
        },
        open_file = {
          quit_on_open = false,
          resize_window = true,
          window_picker = {
            enable = true,
            picker = "default",
            chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",
            exclude = {
              filetype = { "notify", "packer", "qf", "diff", "fugitive", "fugitiveblame" },
              buftype = { "nofile", "terminal", "help" },
            },
          },
        },
        remove_file = {
          close_window = true,
        },
      },

      -- 垃圾桶設置
      trash = {
        cmd = "gio trash",
      },

      -- 即時過濾
      live_filter = {
        prefix = "[FILTER]: ",
        always_show_folders = true,
      },

      -- 標籤頁設置
      tab = {
        sync = {
          open = false,
          close = false,
          ignore = {},
        },
      },

      -- 通知設置
      notify = {
        threshold = vim.log.levels.INFO,
      },

      -- 日志設置
      log = {
        enable = false,
        truncate = false,
        types = {
          all = false,
          config = false,
          copy_paste = false,
          dev = false,
          diagnostics = false,
          git = false,
          profile = false,
          watcher = false,
        },
      },
    })

    -- 按鍵映射
    local api = require("nvim-tree.api")

    -- 全域按鍵映射
    vim.keymap.set("n", "<leader>e", api.tree.toggle, { desc = "切換檔案樹" })
    vim.keymap.set("n", "<leader>E", function()
      api.tree.toggle({ find_file = true, focus = true })
    end, { desc = "切換檔案樹並定位當前檔案" })

    -- 設置檔案樹專用按鍵映射
    local function on_attach(bufnr)
      local function opts(desc)
        return { desc = "nvim-tree: " .. desc, buffer = bufnr, noremap = true, silent = true, nowait = true }
      end

      -- 導航
      vim.keymap.set('n', '<CR>', api.node.open.edit, opts('開啟'))
      vim.keymap.set('n', 'o', api.node.open.edit, opts('開啟'))
      vim.keymap.set('n', 'O', api.node.open.no_window_picker, opts('開啟: 無視窗選擇器'))
      vim.keymap.set('n', '<2-LeftMouse>', api.node.open.edit, opts('開啟'))
      vim.keymap.set('n', '<Tab>', api.node.open.preview, opts('開啟預覽'))

      -- 檔案操作
      vim.keymap.set('n', 'a', api.fs.create, opts('新增檔案或資料夾'))
      vim.keymap.set('n', 'd', api.fs.remove, opts('刪除'))
      vim.keymap.set('n', 'D', api.fs.trash, opts('丟入垃圾桶'))
      vim.keymap.set('n', 'r', api.fs.rename, opts('重新命名'))
      vim.keymap.set('n', '<C-r>', api.fs.rename_sub, opts('重新命名: 省略檔名'))
      vim.keymap.set('n', 'x', api.fs.cut, opts('剪下'))
      vim.keymap.set('n', 'c', api.fs.copy.node, opts('複製'))
      vim.keymap.set('n', 'p', api.fs.paste, opts('貼上'))
      vim.keymap.set('n', 'y', api.fs.copy.filename, opts('複製檔名'))
      vim.keymap.set('n', 'Y', api.fs.copy.relative_path, opts('複製相對路徑'))
      vim.keymap.set('n', 'gy', api.fs.copy.absolute_path, opts('複製絕對路徑'))

      -- 導航和移動
      vim.keymap.set('n', 'P', api.node.navigate.parent, opts('上層目錄'))
      vim.keymap.set('n', 'K', api.node.navigate.sibling.first, opts('第一個同級'))
      vim.keymap.set('n', 'J', api.node.navigate.sibling.last, opts('最後一個同級'))
      vim.keymap.set('n', '<BS>', api.node.navigate.parent_close, opts('關閉目錄'))
      vim.keymap.set('n', 'H', api.tree.collapse_all, opts('收起所有'))

      -- 檢視操作
      vim.keymap.set('n', 'v', api.node.open.vertical, opts('垂直分割開啟'))
      vim.keymap.set('n', 's', api.node.open.horizontal, opts('水平分割開啟'))
      vim.keymap.set('n', 't', api.node.open.tab, opts('新標籤頁開啟'))
      vim.keymap.set('n', '<C-t>', api.node.open.tab, opts('新標籤頁開啟'))
      vim.keymap.set('n', '<C-v>', api.node.open.vertical, opts('垂直分割開啟'))
      vim.keymap.set('n', '<C-x>', api.node.open.horizontal, opts('水平分割開啟'))

      -- 樹操作
      vim.keymap.set('n', 'R', api.tree.reload, opts('重新載入'))
      vim.keymap.set('n', 'q', api.tree.close, opts('關閉'))
      vim.keymap.set('n', 'W', api.tree.collapse_all, opts('收起所有'))
      vim.keymap.set('n', 'E', api.tree.expand_all, opts('展開所有'))

      -- 過濾和搜尋
      vim.keymap.set('n', 'f', api.live_filter.start, opts('即時過濾'))
      vim.keymap.set('n', 'F', api.live_filter.clear, opts('清除過濾'))
      vim.keymap.set('n', 'S', api.tree.search_node, opts('搜尋'))

      -- Git 操作
      vim.keymap.set('n', '[c', api.node.navigate.git.prev, opts('上一個 Git'))
      vim.keymap.set('n', ']c', api.node.navigate.git.next, opts('下一個 Git'))

      -- 診斷
      vim.keymap.set('n', '[e', api.node.navigate.diagnostics.prev, opts('上一個診斷'))
      vim.keymap.set('n', ']e', api.node.navigate.diagnostics.next, opts('下一個診斷'))

      -- 資訊
      vim.keymap.set('n', 'I', api.tree.toggle_gitignore_filter, opts('切換 Git 忽略'))
      vim.keymap.set('n', 'U', api.tree.toggle_custom_filter, opts('切換隱藏'))
      vim.keymap.set('n', '.', api.tree.toggle_hidden_filter, opts('切換點檔案'))
      vim.keymap.set('n', 'i', api.node.show_info_popup, opts('檔案資訊'))
      vim.keymap.set('n', 'g?', api.tree.toggle_help, opts('幫助'))

      -- 標記和書籤
      vim.keymap.set('n', 'm', api.marks.toggle, opts('切換標記'))
      vim.keymap.set('n', 'bmv', api.marks.bulk.move, opts('移動標記檔案'))
    end

    -- 註冊 on_attach 函數
    require("nvim-tree").setup({
      on_attach = on_attach,
    })

    -- 自動命令
    vim.api.nvim_create_autocmd("BufEnter", {
      nested = true,
      callback = function()
        if #vim.api.nvim_list_wins() == 1 and require("nvim-tree.utils").is_nvim_tree_buf() then
          vim.cmd "quit"
        end
      end
    })
  end,
}
```

### 步驟 2: 增強整合功能
**位置**: `lua/plugins/ui/nvim-tree-integrations.lua`

```lua
return {
  "nvim-tree/nvim-tree.lua",
  dependencies = {
    "nvim-tree/nvim-web-devicons",
    "nvim-telescope/telescope.nvim", -- 可選整合
  },
  config = function()
    -- 與 Telescope 整合
    local function telescope_find_files_from_tree()
      local api = require("nvim-tree.api")
      local node = api.tree.get_node_under_cursor()
      local path = node.absolute_path
      
      if node.type == "directory" then
        require("telescope.builtin").find_files({
          cwd = path,
        })
      else
        require("telescope.builtin").find_files({
          cwd = vim.fn.fnamemodify(path, ":h"),
        })
      end
    end

    local function telescope_live_grep_from_tree()
      local api = require("nvim-tree.api")
      local node = api.tree.get_node_under_cursor()
      local path = node.absolute_path
      
      if node.type == "directory" then
        require("telescope.builtin").live_grep({
          cwd = path,
        })
      else
        require("telescope.builtin").live_grep({
          cwd = vim.fn.fnamemodify(path, ":h"),
        })
      end
    end

    -- 自定義函數：在終端機中開啟目錄
    local function open_in_terminal()
      local api = require("nvim-tree.api")
      local node = api.tree.get_node_under_cursor()
      local path = node.absolute_path
      
      if node.type == "directory" then
        vim.cmd("cd " .. vim.fn.fnameescape(path))
        vim.cmd("terminal")
      else
        vim.cmd("cd " .. vim.fn.fnameescape(vim.fn.fnamemodify(path, ":h")))
        vim.cmd("terminal")
      end
    end

    -- 自定義函數：複製檔案路徑到系統剪貼簿
    local function copy_path_to_clipboard()
      local api = require("nvim-tree.api")
      local node = api.tree.get_node_under_cursor()
      local path = node.absolute_path
      
      -- WSL 環境下使用 clip.exe
      if vim.fn.has('wsl') == 1 then
        vim.fn.system("echo " .. vim.fn.shellescape(path) .. " | clip.exe")
      else
        vim.fn.setreg('+', path)
      end
      
      print("路徑已複製: " .. path)
    end

    -- 擴展按鍵映射
    local function extended_on_attach(bufnr)
      local api = require("nvim-tree.api")
      
      local function opts(desc)
        return { desc = "nvim-tree: " .. desc, buffer = bufnr, noremap = true, silent = true, nowait = true }
      end

      -- Telescope 整合
      vim.keymap.set('n', '<C-f>', telescope_find_files_from_tree, opts('Telescope 檔案搜尋'))
      vim.keymap.set('n', '<C-g>', telescope_live_grep_from_tree, opts('Telescope 內容搜尋'))
      
      -- 終端整合
      vim.keymap.set('n', '<C-]>', open_in_terminal, opts('在終端開啟'))
      
      -- 剪貼簿整合
      vim.keymap.set('n', '<C-y>', copy_path_to_clipboard, opts('複製路徑到剪貼簿'))
      
      -- 快速編輯常用檔案
      vim.keymap.set('n', 'gc', function()
        vim.cmd('edit ' .. vim.fn.stdpath('config') .. '/init.lua')
      end, opts('編輯 Neovim 配置'))
    end

    -- 註冊擴展按鍵映射
    local original_setup = require("nvim-tree").setup
    require("nvim-tree").setup = function(opts)
      local original_on_attach = opts.on_attach
      opts.on_attach = function(bufnr)
        if original_on_attach then
          original_on_attach(bufnr)
        end
        extended_on_attach(bufnr)
      end
      return original_setup(opts)
    end
  end,
}
```

## 驗證與測試

### 基本功能測試
1. **開啟/關閉檔案樹**:
   ```vim
   <leader>e
   # 應該切換檔案樹顯示/隱藏
   ```

2. **檔案操作測試**:
   - 按 `a` 新增檔案/資料夾
   - 按 `d` 刪除檔案
   - 按 `r` 重新命名

3. **導航測試**:
   - 按 `o` 或 `<CR>` 開啟檔案
   - 按 `P` 回到上層目錄

### Git 整合測試
```bash
# 修改檔案後檢查 Git 狀態顯示
echo "test" >> test.txt
# 檔案樹中應該顯示 Git 狀態圖示
```

## 按鍵映射總結

### 全域按鍵
- `<leader>e` - 切換檔案樹
- `<leader>E` - 切換檔案樹並定位當前檔案

### 檔案樹內按鍵

#### 基本導航
- `<CR>` / `o` - 開啟檔案/展開目錄
- `O` - 開啟 (無視窗選擇器)
- `<Tab>` - 預覽檔案
- `P` - 回到上層目錄
- `<BS>` - 關閉目錄

#### 檔案操作
- `a` - 新增檔案或資料夾
- `d` - 刪除
- `D` - 丟入垃圾桶
- `r` - 重新命名
- `x` - 剪下
- `c` - 複製
- `p` - 貼上

#### 路徑複製
- `y` - 複製檔名
- `Y` - 複製相對路徑
- `gy` - 複製絕對路徑

#### 檢視模式
- `v` - 垂直分割開啟
- `s` - 水平分割開啟
- `t` - 新標籤頁開啟

#### 樹操作
- `R` - 重新載入
- `q` - 關閉檔案樹
- `W` - 收起所有
- `E` - 展開所有

#### 過濾和搜尋
- `f` - 開始即時過濾
- `F` - 清除過濾
- `S` - 搜尋節點

#### Git 導航
- `[c` / `]c` - 上一個/下一個 Git 變更

#### 診斷導航
- `[e` / `]e` - 上一個/下一個診斷錯誤

#### 顯示設置
- `I` - 切換 Git 忽略檔案顯示
- `U` - 切換自定義過濾
- `.` - 切換隱藏檔案顯示
- `i` - 顯示檔案資訊

## 常見問題與解決方案

### Q1: 檔案樹不顯示圖示
**解決方案**:
1. 確認已安裝 Nerd Font
2. 檢查終端字體設置
3. 確認 `nvim-web-devicons` 已安裝

### Q2: Git 狀態不顯示
**檢查項目**:
1. 確認在 Git 倉庫中
2. 檢查 `git.enable = true`
3. 檢查 Git 權限

### Q3: 檔案操作失敗
**解決方案**:
1. 檢查檔案權限
2. 確認垃圾桶命令設置正確
3. 檢查檔案系統類型

### Q4: 效能問題
**優化方案**:
```lua
filesystem_watchers = {
  enable = false, -- 對大型專案可能需要禁用
},
```

## 進階配置

### 自定義過濾器
```lua
filters = {
  custom = { ".git", "node_modules", ".cache" },
  exclude = { ".gitignore" },
},
```

### 浮動視窗模式
```lua
view = {
  float = {
    enable = true,
    quit_on_focus_loss = true,
    open_win_config = {
      relative = "editor",
      border = "rounded",
      width = 50,
      height = 30,
      row = 1,
      col = 1,
    },
  },
},
```

### 自動同步工作目錄
```lua
-- 檔案樹跟隨工作目錄變化
vim.api.nvim_create_autocmd("DirChanged", {
  callback = function()
    require("nvim-tree.api").tree.change_root(vim.fn.getcwd())
  end,
})
```

## 檢查清單
- [ ] nvim-tree 正常開啟/關閉
- [ ] 檔案操作功能正常
- [ ] Git 狀態顯示正常
- [ ] 圖示顯示正常
- [ ] 按鍵映射設置完成
- [ ] 與其他套件整合正常
- [ ] 效能表現良好

## 與其他模組的集成
- **Telescope**: 從檔案樹啟動搜尋功能
- **Git 整合**: 顯示檔案的 Git 狀態
- **LSP 系統**: 顯示診斷資訊
- **終端整合**: 在特定目錄開啟終端